<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Journal de Trading - EOC Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
    }

    body {
      display: flex;
      min-height: 100vh;
      background-image: url('background.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      transition: all 0.3s ease;
    }

    body.light-mode {
      background-color: #f2f2f2;
      color: #333;
      background-image: none;
    }

    #splash {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #0a1930;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      text-align: center;
    }
    
    #splash h1 {
      font-size: 4rem;
      margin-bottom: 20px;
      animation: fadeIn 2s ease;
    }
    
    #splash p {
      font-size: 1.25rem;
      opacity: 0.8;
    }
    
    #enterBtn {
      margin-top: 40px;
      padding: 12px 25px;
      font-size: 1rem;
      background-color: #4cc9f0;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      opacity: 0;
      animation: fadeIn 1s ease 1s forwards;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    /* Auth Modal Styles */
    .auth-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }

    .auth-container {
      background-color: #1e1e2f;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    body.light-mode .auth-container {
      background-color: #ffffff;
    }

    .auth-container h2 {
      color: white;
      margin-bottom: 20px;
      text-align: center;
    }

    body.light-mode .auth-container h2 {
      color: #333;
    }

    .auth-container input {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border-radius: 5px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background-color: rgba(30, 30, 47, 0.5);
      color: white;
    }

    body.light-mode .auth-container input {
      background-color: white;
      color: #333;
      border: 1px solid #ddd;
    }

    .auth-container button {
      width: 100%;
      padding: 12px;
      border-radius: 5px;
      border: none;
      background-color: #4361ee;
      color: white;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 10px;
    }

    .auth-container button:hover {
      background-color: #3a56d4;
    }

    .auth-container .switch-auth {
      color: #4361ee;
      cursor: pointer;
      text-align: center;
      margin-top: 15px;
    }

    .auth-container .switch-auth:hover {
      text-decoration: underline;
    }

    .auth-container .error-message {
      color: #f87171;
      margin-bottom: 15px;
      text-align: center;
    }

    .user-info {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: white;
      z-index: 101;
    }

    body.light-mode .user-info {
      color: #333;
    }

    .user-info img {
      width: 30px;
      height: 30px;
      border-radius: 50%;
    }

    .user-info .user-email {
      font-size: 14px;
    }

    .user-info .logout-btn {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      font-size: 14px;
    }

    .user-info .logout-btn:hover {
      text-decoration: underline;
    }

    .sidebar {
      background-color: #1e1e2f;
      color: white;
      padding: 20px 10px;
      width: 70px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 25px;
      transition: all 0.3s ease;
      z-index: 100;
    }

    body.light-mode .sidebar {
      background-color: #ffffff;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    .sidebar i {
      font-size: 20px;
      cursor: pointer;
      padding: 10px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .sidebar i:hover, .sidebar i.active {
      background-color: rgba(67, 97, 238, 0.5);
      color: #fff;
    }

    .sidebar i.active {
      background-color: #4361ee;
    }

    body.light-mode .sidebar i {
      color: #333;
    }

    .main {
      flex-grow: 1;
      padding: 20px;
      background-color: rgba(30, 30, 47, 0.9);
      transition: all 0.3s ease;
    }

    body.light-mode .main {
      background-color: rgba(242, 242, 242, 0.9);
    }

    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .card {
      background-color: rgba(30, 41, 59, 0.8);
      padding: 20px;
      border-radius: 10px;
      flex: 1;
      min-width: 200px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
      transition: all 0.3s ease;
    }

    body.light-mode .card {
      background-color: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(0,0,0,0.1);
    }

    .card h4 {
      font-size: 14px;
      color: rgba(255,255,255,0.7);
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }

    body.light-mode .card h4 {
      color: #666;
    }

    .card p {
      font-size: 24px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .profit { color: #4ade80; }
    .loss { color: #f87171; }
    .neutral { color: #4361ee; }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: rgba(30, 41, 59, 0.8);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.1);
      transition: all 0.3s ease;
    }

    body.light-mode table {
      background-color: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(0,0,0,0.1);
    }

    th, td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      transition: all 0.3s ease;
    }

    body.light-mode th, 
    body.light-mode td {
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    th {
      background-color: rgba(30, 30, 47, 0.7);
      font-weight: 600;
      color: rgba(255,255,255,0.7);
      transition: all 0.3s ease;
    }

    body.light-mode th {
      background-color: rgba(244, 244, 244, 0.9);
      color: #555;
    }

    tr:nth-child(even) {
      background-color: rgba(255,255,255,0.03);
    }

    body.light-mode tr:nth-child(even) {
      background-color: rgba(0,0,0,0.02);
    }

    tr:hover {
      background-color: rgba(67, 97, 238, 0.1);
    }

    .badge {
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }

    .buy { background-color: rgba(74, 222, 128, 0.2); color: #4ade80; }
    .sell { background-color: rgba(248, 113, 113, 0.2); color: #f87171; }
    
    .tag {
      background-color: rgba(67, 97, 238, 0.2);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      display: inline-block;
      color: #4361ee;
      transition: all 0.3s ease;
    }

    body.light-mode .tag {
      background-color: rgba(67, 97, 238, 0.1);
    }

    .add-trade {
      background-color: rgba(30, 41, 59, 0.8);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.1);
      transition: all 0.3s ease;
    }

    body.light-mode .add-trade {
      background-color: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(0,0,0,0.1);
    }

    .add-trade h3 {
      margin-bottom: 15px;
      color: rgba(255,255,255,0.9);
      transition: all 0.3s ease;
    }

    body.light-mode .add-trade h3 {
      color: #333;
    }

    .add-trade input, 
    .add-trade select {
      padding: 10px;
      margin-bottom: 12px;
      width: 100%;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 5px;
      font-size: 14px;
      background-color: rgba(30, 30, 47, 0.5);
      color: white;
      transition: all 0.3s ease;
    }

    body.light-mode .add-trade input,
    body.light-mode .add-trade select {
      background-color: white;
      color: #333;
      border: 1px solid #ddd;
    }

    .add-trade button {
      background-color: #4361ee;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: background-color 0.3s;
      width: 100%;
    }

    .add-trade button:hover {
      background-color: #3a56d4;
    }

    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }

    .form-row > * {
      flex: 1;
    }

    .filter-container {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-container input,
    .filter-container select {
      padding: 10px;
      border-radius: 5px;
      border: 1px solid rgba(255,255,255,0.1);
      background-color: rgba(30, 30, 47, 0.5);
      color: white;
      min-width: 200px;
    }

    body.light-mode .filter-container input,
    body.light-mode .filter-container select {
      background-color: white;
      color: #333;
      border: 1px solid #ddd;
    }

    .export-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .export-buttons button {
      padding: 10px 15px;
      border-radius: 5px;
      border: none;
      background-color: #4361ee;
      color: white;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .export-buttons button:hover {
      background-color: #3a56d4;
    }

    .export-buttons button.reset-btn {
      background-color: #f87171;
    }

    .export-buttons button.reset-btn:hover {
      background-color: #ef4444;
    }

    .export-buttons button.save-btn {
      background-color: #4ade80;
    }

    .export-buttons button.save-btn:hover {
      background-color: #22c55e;
    }

    .chart-container {
      background-color: rgba(30, 41, 59, 0.8);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.1);
      transition: all 0.3s ease;
    }

    body.light-mode .chart-container {
      background-color: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(0,0,0,0.1);
    }

    .chart-container h2 {
      margin-bottom: 20px;
      color: rgba(255,255,255,0.9);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    body.light-mode .chart-container h2 {
      color: #333;
    }

    .broker-card {
      background-color: rgba(30, 41, 59, 0.8);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.1);
      transition: all 0.3s ease;
      position: relative;
    }

    body.light-mode .broker-card {
      background-color: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(0,0,0,0.1);
    }

    .broker-card h3 {
      margin-bottom: 10px;
      color: rgba(255,255,255,0.9);
      transition: all 0.3s ease;
    }

    body.light-mode .broker-card h3 {
      color: #333;
    }

    .broker-card p {
      color: rgba(255,255,255,0.7);
      margin-bottom: 5px;
      transition: all 0.3s ease;
    }

    body.light-mode .broker-card p {
      color: #666;
    }

    .broker-link {
      display: inline-block;
      margin-top: 10px;
      padding: 8px 15px;
      background-color: #4361ee;
      color: white;
      border-radius: 5px;
      text-decoration: none;
      font-weight: 500;
      transition: all 0.3s;
    }

    .broker-link:hover {
      background-color: #3a56d4;
    }

    .settings-option {
      margin-bottom: 20px;
    }

    .settings-option h3 {
      margin-bottom: 10px;
      color: rgba(255,255,255,0.9);
      transition: all 0.3s ease;
    }

    body.light-mode .settings-option h3 {
      color: #333;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #4361ee;
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    .language-selector {
      display: flex;
      gap: 15px;
      margin-top: 10px;
    }

    .language-option {
      padding: 8px 15px;
      border-radius: 5px;
      background-color: rgba(67, 97, 238, 0.2);
      color: #4361ee;
      cursor: pointer;
      transition: all 0.3s;
    }

    .language-option.active {
      background-color: #4361ee;
      color: white;
    }

    /* Emotional Patterns */
    .emotional-patterns {
      background-color: rgba(30, 41, 59, 0.8);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.1);
      transition: all 0.3s ease;
      text-align: center;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    body.light-mode .emotional-patterns {
      background-color: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(0,0,0,0.1);
    }

    .emotional-patterns h3 {
      margin-bottom: 15px;
      color: rgba(255,255,255,0.9);
      transition: all 0.3s ease;
    }

    body.light-mode .emotional-patterns h3 {
      color: #333;
    }

    .emotional-patterns p {
      font-size: 16px;
      color: rgba(255,255,255,0.9);
      font-style: italic;
      transition: all 0.3s ease;
    }

    body.light-mode .emotional-patterns p {
      color: #555;
    }

    /* Daily Feedback */
    .daily-feedback {
      background-color: rgba(30, 41, 59, 0.8);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.1);
      transition: all 0.3s ease;
      text-align: center;
    }

    body.light-mode .daily-feedback {
      background-color: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(0,0,0,0.1);
    }

    .daily-feedback h3 {
      margin-bottom: 15px;
      color: rgba(255,255,255,0.9);
      transition: all 0.3s ease;
    }

    body.light-mode .daily-feedback h3 {
      color: #333;
    }

    .daily-feedback p {
      font-size: 16px;
      color: rgba(255,255,255,0.9);
      font-style: italic;
      transition: all 0.3s ease;
    }

    body.light-mode .daily-feedback p {
      color: #555;
    }

    /* Welcome message */
    .welcome-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(30, 41, 59, 0.95);
      padding: 20px 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      z-index: 1000;
      text-align: center;
      max-width: 80%;
      animation: fadeIn 0.5s ease;
      border: 1px solid #4361ee;
    }

    .welcome-message h2 {
      color: #4cc9f0;
      margin-bottom: 10px;
    }

    .welcome-message p {
      color: rgba(255,255,255,0.9);
      margin-bottom: 20px;
    }

    .welcome-message button {
      padding: 10px 20px;
      background-color: #4361ee;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
    }

    .welcome-message button:hover {
      background-color: #3a56d4;
    }

    /* Hide sections by default */
    .section {
      display: none;
    }
    
    .section.active {
      display: block;
    }

    /* Non-logged state */
    .non-logged-message {
      text-align: center;
      padding: 40px 20px;
      background-color: rgba(30, 41, 59, 0.8);
      border-radius: 10px;
      margin: 20px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .non-logged-message h2 {
      color: #4cc9f0;
      margin-bottom: 15px;
    }

    .non-logged-message p {
      color: rgba(255,255,255,0.8);
      margin-bottom: 20px;
    }

    .non-logged-message button {
      padding: 12px 25px;
      background-color: #4361ee;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
    }

    .non-logged-message button:hover {
      background-color: #3a56d4;
    }

    @media (max-width: 768px) {
      .stats {
        flex-direction: column;
      }
      
      .sidebar {
        width: 60px;
        padding: 15px 5px;
        gap: 15px;
      }
      
      .main {
        padding: 15px;
      }
      
      th, td {
        padding: 8px;
        font-size: 14px;
      }
      
      .form-row {
        flex-direction: column;
        gap: 0;
      }

      .filter-container {
        flex-direction: column;
        gap: 10px;
      }

      .filter-container input,
      .filter-container select {
        min-width: 100%;
      }

      .export-buttons button {
        padding: 8px 12px;
        font-size: 12px;
      }

      .user-info {
        position: static;
        justify-content: flex-end;
        margin-bottom: 15px;
      }

      .user-info .user-email {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div id="splash">
    <h1>EOC</h1>
    <p>Bienvenue dans ton Journal de Trading</p>
    <button id="enterBtn">Welcome</button>
  </div>

  <!-- Auth Modal -->
  <div id="authModal" class="auth-modal">
    <div class="auth-container">
      <div id="loginView">
        <h2>CONNEXION</h2>
        <div id="loginError" class="error-message"></div>
        <input type="email" id="loginEmail" placeholder="Email">
        <input type="password" id="loginPassword" placeholder="Mot de passe">
        <button id="loginBtn">Se connecter</button>
        <button id="googleLoginBtn">Se connecter avec Google</button>
        <div class="switch-auth" id="showRegister">Créer un compte</div>
      </div>
      
      <div id="registerView" style="display: none;">
        <h2>CRÉER UN COMPTE</h2>
        <div id="registerError" class="error-message"></div>
        <input type="email" id="registerEmail" placeholder="Email">
        <input type="password" id="registerPassword" placeholder="Mot de passe (6 caractères min)">
        <input type="password" id="registerConfirmPassword" placeholder="Confirmer le mot de passe">
        <button id="registerBtn">S'inscrire</button>
        <div class="switch-auth" id="showLogin">Déjà un compte ? Se connecter</div>
      </div>
    </div>
  </div>

  <div id="mainApp" style="display: none;">
    <div class="user-info">
      <span class="user-email" id="userEmail"></span>
      <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i></button>
    </div>

    <div class="sidebar">
      <i class="fas fa-tachometer-alt active" data-section="dashboard"></i>
      <i class="fas fa-chart-bar" data-section="performance"></i>
      <i class="fas fa-building" data-section="brokers"></i>
      <i class="fas fa-cog" data-section="settings"></i>
    </div>

    <div class="main">
      <!-- Dashboard Section -->
      <section id="dashboard-section" class="section active">
        <div id="nonLoggedMessage" class="non-logged-message" style="display: none;">
          <h2>Connectez-vous pour accéder à votre journal</h2>
          <p>Veuillez vous connecter ou créer un compte pour enregistrer et suivre vos trades.</p>
          <button id="loginFromAppBtn">Se connecter</button>
        </div>

        <div id="loggedContent" style="display: none;">
          <div class="emotional-patterns">
            <h3>PATTERN ÉMOTIONNEL</h3>
            <p id="emotionalPatternText">Le capital c'est ton oxygène. Protège-le.</p>
          </div>

          <div class="daily-feedback">
            <h3>FEEDBACK QUOTIDIEN</h3>
            <p id="dailyFeedbackText">Analyse de tes performances en cours...</p>
          </div>

          <div class="stats">
            <div class="card">
              <h4>TRADES</h4>
              <p class="neutral" id="totalTrades">0</p>
            </div>
            <div class="card">
              <h4>WIN RATE</h4>
              <p class="profit" id="winRate">0%</p>
            </div>
            <div class="card">
              <h4>PROFIT</h4>
              <p class="profit" id="totalProfit">$0</p>
            </div>
            <div class="card">
              <h4>AVG R/R RATIO</h4>
              <p class="neutral" id="averageRRR">0</p>
            </div>
            <div class="card">
              <h4>CAPITAL</h4>
              <p class="neutral" id="currentCapital">$1000</p>
            </div>
          </div>

          <div class="filter-container">
            <input type="text" id="symbolFilter" placeholder="Filtrer par symbole" oninput="filterTrades()">
            <input type="text" id="dateFromFilter" placeholder="Date de début" class="date-filter">
            <input type="text" id="dateToFilter" placeholder="Date de fin" class="date-filter">
            <select id="resultFilter" onchange="filterTrades()">
              <option value="all">Tous les résultats</option>
              <option value="win">Gagnants seulement</option>
              <option value="loss">Perdants seulement</option>
            </select>
          </div>

          <div class="export-buttons">
            <button onclick="exportToCSV()"><i class="fas fa-file-csv"></i> Exporter CSV</button>
            <button onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Exporter Excel</button>
            <button onclick="importFromFile()"><i class="fas fa-file-import"></i> Importer</button>
            <button class="save-btn" onclick="saveJournal()"><i class="fas fa-save"></i> Sauvegarder</button>
            <button class="reset-btn" onclick="resetJournal()"><i class="fas fa-trash-alt"></i> Réinitialiser</button>
            <input type="file" id="fileInput" style="display: none;" accept=".csv,.xlsx,.xls">
          </div>

          <table id="tradeTable">
            <thead>
              <tr>
                <th>DATE</th>
                <th>SYMBOLE</th>
                <th>TYPE</th>
                <th>ENTRY</th>
                <th>SORTIE</th>
                <th>LOT</th>
                <th>RÉSULTAT</th>
                <th>P&L</th>
                <th>R/R</th>
                <th>ACTIONS</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <div class="add-trade">
            <h3>AJOUTER UN TRADE</h3>
            <div class="form-row">
              <input type="text" id="tradeDate" class="date-input" placeholder="Date">
              <input type="text" id="tradeSymbol" placeholder="Symbole (ex: EURUSD)">
              <select id="tradeType">
                <option value="Buy">Buy</option>
                <option value="Sell">Sell</option>
              </select>
            </div>
            <div class="form-row">
              <input type="number" id="tradeEntry" placeholder="Prix d'entrée" step="0.0001">
              <input type="number" id="tradeExit" placeholder="Prix de sortie" step="0.0001">
              <input type="number" id="tradeLot" placeholder="Lot (0.01 min)" step="0.01" min="0.01">
            </div>
            <div class="form-row">
              <select id="tradeResult">
                <option value="win">Win</option>
                <option value="loss">Loss</option>
              </select>
              <input type="number" id="tradePL" placeholder="Profit/Loss">
              <input type="number" id="tradeRR" placeholder="R/R Ratio" readonly>
            </div>
            <button type="button" onclick="saveTrade()">AJOUTER LE TRADE</button>
          </div>
        </div>
      </section>

      <!-- Performance Section -->
      <section id="performance-section" class="section">
        <div id="nonLoggedMessagePerformance" class="non-logged-message" style="display: none;">
          <h2>Connectez-vous pour accéder à l'analyse de performance</h2>
          <p>Veuillez vous connecter ou créer un compte pour visualiser vos statistiques de trading.</p>
          <button id="loginFromPerformanceBtn">Se connecter</button>
        </div>

        <div id="loggedContentPerformance" style="display: none;">
          <h1><i class="fas fa-chart-bar"></i> ANALYSE DE PERFORMANCE</h1>
          
          <div class="stats">
            <div class="card">
              <h4>RISK/REWARD MOYEN</h4>
              <p class="neutral" id="avgRiskReward">0</p>
            </div>
            <div class="card">
              <h4>MAX DRAWNDOWN</h4>
              <p class="loss" id="maxDrawdown">$0</p>
            </div>
            <div class="card">
              <h4>MAX LOSS/JOUR</h4>
              <p class="loss" id="maxDailyLoss">$0</p>
            </div>
            <div class="card">
              <h4>MAX WIN/JOUR</h4>
              <p class="profit" id="maxDailyWin">$0</p>
            </div>
          </div>

          <div class="chart-container">
            <h2><i class="fas fa-chart-line"></i> EVOLUTION DU CAPITAL</h2>
            <canvas id="capitalChart" height="300"></canvas>
          </div>
          
          <div class="chart-container">
            <h2><i class="fas fa-chart-pie"></i> REPARTITION GAINS/PERDUS</h2>
            <canvas id="pieChart" height="300"></canvas>
          </div>
          
          <div class="chart-container">
            <h2><i class="fas fa-chart-bar"></i> PERFORMANCE PAR JOUR</h2>
            <canvas id="dailyChart" height="300"></canvas>
          </div>
        </div>
      </section>

      <!-- Brokers Section -->
      <section id="brokers-section" class="section">
        <h1><i class="fas fa-building"></i> RECOMMANDATION DE BROKERS</h1>
        
        <div id="brokersList">
          <!-- Recommended Brokers -->
          <div class="broker-card">
            <h3>EXNESS</h3>
            <p><strong>Spread:</strong> À partir de 0.0 pips</p>
            <p><strong>Effet de levier:</strong> Jusqu'à 1:Unlimited</p>
            <p><strong>Régulation:</strong> FSA, CySEC, FCA</p>
            <p><strong>Dépôt minimum:</strong> $10</p>
            <p><strong>Note:</strong> ★★★★★</p>
            <a href="https://one.exnesstrack.org/a/i911hyordj" target="_blank" class="broker-link">Ouvrir un compte</a>
          </div>
          
          <div class="broker-card">
            <h3>LITEFINANCE</h3>
            <p><strong>Spread:</strong> À partir de 0.0 pips</p>
            <p><strong>Effet de levier:</strong> Jusqu'à 1:500</p>
            <p><strong>Régulation:</strong> CySEC, FSA</p>
            <p><strong>Dépôt minimum:</strong> $50</p>
            <p><strong>Note:</strong> ★★★★☆</p>
            <a href="https://www.litefinance.org/?uid=114959820" target="_blank" class="broker-link">Ouvrir un compte</a>
          </div>
          
          <div class="broker-card">
            <h3>HEADWAY</h3>
            <p><strong>Spread:</strong> À partir de 0.0 pips</p>
            <p><strong>Effet de levier:</strong> Jusqu'à 1:500</p>
            <p><strong>Régulation:</strong> FSA, CySEC</p>
            <p><strong>Dépôt minimum:</strong> $10</p>
            <p><strong>Note:</strong> ★★★★☆</p>
            <a href="https://headway.partners/user/signup?hwp=2107f0" target="_blank" class="broker-link">Ouvrir un compte</a>
          </div>
          
          <div class="broker-card">
            <h3>FBS</h3>
            <p><strong>Spread:</strong> À partir de 0.5 pips</p>
            <p><strong>Effet de levier:</strong> Jusqu'à 1:3000</p>
            <p><strong>Régulation:</strong> IFSC, CySEC, ASIC</p>
            <p><strong>Dépôt minimum:</strong> $5</p>
            <p><strong>Note:</strong> ★★★★☆</p>
            <a href="https://fbs.partners?ibl=891392&ibp=25515221" target="_blank" class="broker-link">Ouvrir un compte</a>
          </div>
          
          <div class="broker-card">
            <h3>ROBOFOREX</h3>
            <p><strong>Spread:</strong> À partir de 0.0 pips</p>
            <p><strong>Effet de levier:</strong> Jusqu'à 1:2000</p>
            <p><strong>Régulation:</strong> CySEC, IFSC</p>
            <p><strong>Dépôt minimum:</strong> $10</p>
            <p><strong>Note:</strong> ★★★★☆</p>
            <a href="https://my.roboforex.com/en/?a=eqylm" target="_blank" class="broker-link">Ouvrir un compte</a>
          </div>
        </div>
      </section>

      <!-- Settings Section -->
      <section id="settings-section" class="section">
        <div id="nonLoggedMessageSettings" class="non-logged-message" style="display: none;">
          <h2>Connectez-vous pour accéder aux paramètres</h2>
          <p>Veuillez vous connecter ou créer un compte pour personnaliser votre expérience.</p>
          <button id="loginFromSettingsBtn">Se connecter</button>
        </div>

        <div id="loggedContentSettings" style="display: none;">
          <h1><i class="fas fa-cog"></i> PARAMÈTRES</h1>
          
          <div class="settings-option">
            <h3>APPARENCE</h3>
            <label class="switch">
              <input type="checkbox" id="darkModeToggle" checked>
              <span class="slider"></span>
            </label>
            <span style="margin-left: 10px;">Mode sombre</span>
          </div>
          
          <div class="settings-option">
            <h3>LANGUE</h3>
            <div class="language-selector">
              <div class="language-option active" data-lang="fr">Français</div>
              <div class="language-option" data-lang="en">English</div>
            </div>
          </div>
          
          <div class="settings-option">
            <h3>CAPITAL INITIAL</h3>
            <input type="number" id="initialCapital" value="1000" style="width: 200px; padding: 10px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.1); background-color: rgba(30, 30, 47, 0.5); color: white;">
            <button onclick="updateCapital()" style="margin-left: 10px; padding: 10px 15px; border-radius: 5px; border: none; background-color: #4361ee; color: white; cursor: pointer;">Mettre à jour</button>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Welcome Message Modal -->
  <div id="welcomeMessage" class="welcome-message" style="display: none;">
    <h2 id="welcomeTitle">Bienvenue !</h2>
    <p id="welcomeText">Vous êtes maintenant connecté à votre journal de trading.</p>
    <button id="closeWelcomeBtn">Commencer</button>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyArp7tg8vG9LALidofLGMyPLo0_kkf5Gvw",
      authDomain: "eoc-tradingjournal.firebaseapp.com",
      projectId: "eoc-tradingjournal",
      storageBucket: "eoc-tradingjournal.appspot.com",
      messagingSenderId: "1040650682872",
      appId: "1:1040650682872:web:97ec728bfee0577ce2160d"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Variables globales
    let trades = [];
    let allTrades = [];
    let capitalChart, pieChart, dailyChart;
    let currentSection = 'dashboard';
    let initialCapital = 1000;
    let currentLanguage = 'fr';
    let darkMode = true;
    let emotionalPatternIndex = 0;
    let emotionalPatternInterval;
    let lastDailyFeedbackDate = null;
    let currentUser = null;

    // Patterns émotionnels
    const emotionalPatterns = [
      "Le capital c'est ton oxygène. Protège-le.",
      "Si tu n'es pas sûr, ne trade pas. L'inaction est parfois la meilleure décision.",
      "3 pertes d'affilée ? Pause. Reviens l'esprit clair.",
      "La patience paie. Ne cours pas après le marché.",
      "Le journal est ton miroir : il révèle la vérité.",
      "Moins de trades, mais de meilleure qualité.",
      "Le FOMO est ton ennemi, reste maître de toi.",
      "Tu ne peux pas contrôler le marché, mais tu peux contrôler tes actions."
    ];

    // Feedbacks quotidiens
    const dailyFeedbacks = [
      "Analyse tes trades perdants pour identifier les patterns à éviter.",
      "Félicitations pour ta discipline ! Continue sur cette voie.",
      "Ton win rate est en hausse, c'est excellent !",
      "Attention à ne pas sur-trader aujourd'hui. Qualité plutôt que quantité.",
      "Tes trades ont un bon ratio risk/reward, continue comme ça !",
      "Prends le temps d'analyser le marché avant d'entrer en position.",
      "Ton capital augmente régulièrement, c'est le signe d'une bonne stratégie.",
      "N'oublie pas de définir ton stop loss avant chaque trade."
    ];

    // Auth Functions
    function showAuthModal() {
      document.getElementById('authModal').style.display = 'flex';
    }

    function hideAuthModal() {
      document.getElementById('authModal').style.display = 'none';
      document.getElementById('loginError').textContent = '';
      document.getElementById('registerError').textContent = '';
    }

    function showLoginView() {
      document.getElementById('loginView').style.display = 'block';
      document.getElementById('registerView').style.display = 'none';
    }

    function showRegisterView() {
      document.getElementById('loginView').style.display = 'none';
      document.getElementById('registerView').style.display = 'block';
    }

    function registerUser(email, password) {
      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          // User registered successfully
          currentUser = userCredential.user;
          
          // Create user data in Firestore
          return db.collection('users').doc(userCredential.user.uid).set({
            email: userCredential.user.email,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            initialCapital: 1000,
            darkMode: true,
            currentLanguage: 'fr',
            lastDailyFeedbackDate: null
          });
        })
        .then(() => {
          hideAuthModal();
          showWelcomeMessage(currentUser.email, true);
          loadUserData();
        })
        .catch((error) => {
          document.getElementById('registerError').textContent = error.message;
        });
    }

    function loginUser(email, password) {
      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          // User logged in successfully
          currentUser = userCredential.user;
          hideAuthModal();
          showWelcomeMessage(currentUser.email, false);
          loadUserData();
        })
        .catch((error) => {
          document.getElementById('loginError').textContent = error.message;
        });
    }

    function logoutUser() {
      auth.signOut().then(() => {
        currentUser = null;
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('splash').style.display = 'flex';
        showAuthModal();
      });
    }

    function showWelcomeMessage(email, isNewUser) {
      const welcomeTitle = document.getElementById('welcomeTitle');
      const welcomeText = document.getElementById('welcomeText');
      
      if (isNewUser) {
        welcomeTitle.textContent = currentLanguage === 'fr' ? 'Bienvenue !' : 'Welcome!';
        welcomeText.textContent = currentLanguage === 'fr' 
          ? `Votre compte a été créé avec succès. Vous êtes maintenant connecté en tant que ${email}.` 
          : `Your account has been created successfully. You are now logged in as ${email}.`;
      } else {
        welcomeTitle.textContent = currentLanguage === 'fr' ? 'Content de vous revoir !' : 'Welcome back!';
        welcomeText.textContent = currentLanguage === 'fr' 
          ? `Vous êtes maintenant connecté en tant que ${email}.` 
          : `You are now logged in as ${email}.`;
      }
      
      document.getElementById('welcomeMessage').style.display = 'block';
    }

    function toggleLoggedUI(isLoggedIn) {
      // Show/hide dashboard content
      document.getElementById('nonLoggedMessage').style.display = isLoggedIn ? 'none' : 'block';
      document.getElementById('loggedContent').style.display = isLoggedIn ? 'block' : 'none';
      
      // Show/hide performance content
      document.getElementById('nonLoggedMessagePerformance').style.display = isLoggedIn ? 'none' : 'block';
      document.getElementById('loggedContentPerformance').style.display = isLoggedIn ? 'block' : 'none';
      
      // Show/hide settings content
      document.getElementById('nonLoggedMessageSettings').style.display = isLoggedIn ? 'none' : 'block';
      document.getElementById('loggedContentSettings').style.display = isLoggedIn ? 'block' : 'none';
      
      // Show/hide user info
      document.querySelector('.user-info').style.display = isLoggedIn ? 'flex' : 'none';
    }

    function loadUserData() {
      if (!currentUser) {
        toggleLoggedUI(false);
        return;
      }

      // Update UI with user info
      document.getElementById('userEmail').textContent = currentUser.email;
      toggleLoggedUI(true);
      
      // Load user's trading journal data from Firestore
      const userRef = db.collection('users').doc(currentUser.uid);
      
      // Load user settings
      userRef.get().then((doc) => {
        if (doc.exists) {
          const userData = doc.data();
          
          initialCapital = userData.initialCapital || 1000;
          lastDailyFeedbackDate = userData.lastDailyFeedbackDate || null;
          darkMode = userData.darkMode !== false;
          currentLanguage = userData.currentLanguage || 'fr';
          
          // Update UI
          document.getElementById('initialCapital').value = initialCapital;
          document.getElementById('darkModeToggle').checked = darkMode;
          if (!darkMode) document.body.classList.add('light-mode');
          
          document.querySelectorAll('.language-option').forEach(opt => {
            opt.classList.remove('active');
            if (opt.getAttribute('data-lang') === currentLanguage) {
              opt.classList.add('active');
            }
          });
          
          // Load trades from subcollection
          return userRef.collection('trades').orderBy('date', 'desc').get();
        } else {
          // Create user document if it doesn't exist
          return userRef.set({
            email: currentUser.email,
            initialCapital: 1000,
            darkMode: true,
            currentLanguage: 'fr',
            lastDailyFeedbackDate: null
          }).then(() => {
            return userRef.collection('trades').get(); // Returns empty collection
          });
        }
      }).then((querySnapshot) => {
        const table = document.querySelector("#tradeTable tbody");
        table.innerHTML = '';
        trades = [];
        
        querySnapshot.forEach((doc) => {
          const trade = doc.data();
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${trade.date}</td>
            <td>${trade.symbol}</td>
            <td><span class="badge ${trade.type.toLowerCase()}">${trade.type}</span></td>
            <td>${trade.entry.toFixed(4)}</td>
            <td>${trade.exit.toFixed(4)}</td>
            <td>${trade.lot.toFixed(2)}</td>
            <td><span class="badge ${trade.result}">${trade.result === 'win' ? (currentLanguage === 'fr' ? 'Gagné' : 'Win') : (currentLanguage === 'fr' ? 'Perdu' : 'Loss')}</span></td>
            <td class="${trade.result === 'win' ? 'profit' : 'loss'}">${trade.result === 'win' ? '+' : '-'}${Math.abs(trade.pl).toFixed(2)}</td>
            <td>${trade.rrr.toFixed(2)}</td>
            <td><i class="fas fa-trash" onclick="deleteTrade('${doc.id}')" style="cursor:pointer;color:#f87171;"></i></td>
          `;
          table.appendChild(row);
          trades.push(trade);
        });
        
        allTrades = [...trades];
        
        // Update stats
        updateStats();
        updatePerformanceStats();
        generateDailyFeedback();
      }).catch((error) => {
        console.error("Error loading data:", error);
      });
    }

    function saveUserData() {
      if (!currentUser) return;
      
      const userRef = db.collection('users').doc(currentUser.uid);
      
      // Prepare data to save
      const userData = {
        initialCapital: initialCapital,
        lastDailyFeedbackDate: lastDailyFeedbackDate,
        darkMode: darkMode,
        currentLanguage: currentLanguage,
        email: currentUser.email,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      userRef.set(userData, { merge: true })
        .then(() => {
          const message = currentLanguage === 'fr' 
            ? 'Préférences sauvegardées avec succès !' 
            : 'Preferences saved successfully!';
          console.log(message);
        })
        .catch((error) => {
          console.error("Error saving user data:", error);
          alert(currentLanguage === 'fr' 
            ? 'Erreur lors de la sauvegarde' 
            : 'Error saving data');
        });
    }

    // Sauvegarder le journal complet
    function saveJournal() {
      if (currentUser) {
        saveUserData();
        alert(currentLanguage === 'fr' 
          ? 'Journal sauvegardé avec succès !' 
          : 'Journal saved successfully!');
      } else {
        const message = currentLanguage === 'fr' 
          ? 'Veuillez vous connecter pour sauvegarder' 
          : 'Please login to save';
        alert(message);
        showAuthModal();
      }
    }

    // Réinitialiser le journal
    function resetJournal() {
      const confirmMsg = currentLanguage === 'fr' 
        ? 'Êtes-vous sûr de vouloir réinitialiser tout le journal ? Toutes les données seront perdues.' 
        : 'Are you sure you want to reset the entire journal? All data will be lost.';
      
      if (confirm(confirmMsg)) {
        // Réinitialiser les trades
        document.querySelector("#tradeTable tbody").innerHTML = '';
        
        // Réinitialiser les paramètres par défaut
        initialCapital = 1000;
        document.getElementById('initialCapital').value = initialCapital;
        
        if (currentUser) {
          // Delete all trades from Firestore
          const batch = db.batch();
          const tradesRef = db.collection('users').doc(currentUser.uid).collection('trades');
          
          return tradesRef.get().then((querySnapshot) => {
            querySnapshot.forEach((doc) => {
              batch.delete(doc.ref);
            });
            return batch.commit();
          }).then(() => {
            // Update user settings
            return saveUserData();
          }).then(() => {
            // Réinitialiser les graphiques
            updateCharts();
            updatePerformanceStats();
            
            // Afficher un message
            const message = currentLanguage === 'fr' 
              ? 'Journal réinitialisé avec succès !' 
              : 'Journal reset successfully!';
            alert(message);
          });
        } else {
          localStorage.setItem('initialCapital', initialCapital);
          
          // Réinitialiser les graphiques
          updateCharts();
          updatePerformanceStats();
          
          // Afficher un message
          const message = currentLanguage === 'fr' 
            ? 'Journal réinitialisé avec succès !' 
            : 'Journal reset successfully!';
          alert(message);
        }
      }
    }

    // Afficher le prochain pattern émotionnel
    function showNextEmotionalPattern() {
      emotionalPatternIndex = (emotionalPatternIndex + 1) % emotionalPatterns.length;
      document.getElementById('emotionalPatternText').textContent = emotionalPatterns[emotionalPatternIndex];
    }

    // Générer un feedback quotidien basé sur les performances
    function generateDailyFeedback() {
      const today = new Date().toISOString().split('T')[0];
      
      // Ne générer qu'un feedback par jour
      if (lastDailyFeedbackDate === today) return;
      
      lastDailyFeedbackDate = today;
      
      if (currentUser) {
        saveUserData();
      } else {
        localStorage.setItem('lastDailyFeedbackDate', today);
      }
      
      // Sélectionner un feedback aléatoire ou basé sur les performances
      let feedback;
      if (trades.length === 0) {
        feedback = "Commence par ajouter tes premiers trades pour obtenir des analyses personnalisées.";
      } else {
        const winRate = parseFloat(document.getElementById('winRate').textContent);
        const avgRR = parseFloat(document.getElementById('averageRRR').textContent);
        
        if (winRate < 40) {
          feedback = "Ton win rate est bas. Revois tes critères d'entrée ou tes stops.";
        } else if (winRate > 60) {
          feedback = "Excellent win rate ! Continue à appliquer ta stratégie avec discipline.";
        } else if (avgRR < 1) {
          feedback = "Ton ratio risk/reward moyen est faible. Essaye de viser des trades avec un meilleur potentiel.";
        } else {
          // Sélectionner un feedback aléatoire parmi les options restantes
          const randomIndex = Math.floor(Math.random() * dailyFeedbacks.length);
          feedback = dailyFeedbacks[randomIndex];
        }
      }
      
      document.getElementById('dailyFeedbackText').textContent = feedback;
    }

    // Initialisation des graphiques
    function initCharts() {
      const capitalCtx = document.getElementById('capitalChart').getContext('2d');
      capitalChart = new Chart(capitalCtx, {
        type: 'line',
        data: { 
          labels: [],
          datasets: [{
            label: 'Capital',
            data: [],
            backgroundColor: 'rgba(67, 97, 238, 0.1)',
            borderColor: '#4361ee',
            borderWidth: 2,
            tension: 0.1,
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            annotation: {
              annotations: {
                line1: {
                  type: 'line',
                  yMin: initialCapital,
                  yMax: initialCapital,
                  borderColor: 'rgb(255, 99, 132)',
                  borderWidth: 2,
                  borderDash: [6, 6],
                  label: {
                    content: 'Capital initial',
                    enabled: true,
                    position: 'right'
                  }
                }
              }
            }
          }
        }
      });
      
      const pieCtx = document.getElementById('pieChart').getContext('2d');
      pieChart = new Chart(pieCtx, {
        type: 'doughnut',
        data: { 
          labels: ['Gagnants', 'Perdants'], 
          datasets: [{
            data: [0, 0],
            backgroundColor: ['#4ade80', '#f87171'],
            borderColor: ['rgba(255,255,255,0.8)', 'rgba(255,255,255,0.8)'],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' }
          },
          cutout: '70%'
        }
      });
      
      const dailyCtx = document.getElementById('dailyChart').getContext('2d');
      dailyChart = new Chart(dailyCtx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Profit par jour',
            data: [],
            backgroundColor: [],
            borderColor: [],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: false
            }
          }
        }
      });
    }

    // Sauvegarder un trade
    function saveTrade() {
      if (!currentUser) {
        alert(currentLanguage === 'fr' 
          ? 'Veuillez vous connecter pour enregistrer des trades' 
          : 'Please login to save trades');
        showAuthModal();
        return;
      }

      const date = document.getElementById('tradeDate').value;
      const symbol = document.getElementById('tradeSymbol').value.toUpperCase();
      const type = document.getElementById('tradeType').value;
      const entry = parseFloat(document.getElementById('tradeEntry').value) || 0;
      const exit = parseFloat(document.getElementById('tradeExit').value) || 0;
      const lot = parseFloat(document.getElementById('tradeLot').value) || 0;
      const result = document.getElementById('tradeResult').value;
      const pl = parseFloat(document.getElementById('tradePL').value) || 0;
      
      if (!date || !symbol || lot < 0.01) {
        alert(currentLanguage === 'fr' ? 'Veuillez remplir tous les champs requis (date, symbole, lot minimum 0.01)' : 'Please fill all required fields (date, symbol, minimum lot 0.01)');
        return;
      }
      
      // Calcul du R/R ratio
      const rr = calculateRR(entry, exit, result, pl);
      
      const tradeData = {
        date: date,
        symbol: symbol,
        type: type,
        entry: entry,
        exit: exit,
        lot: lot,
        result: result,
        pl: result === 'win' ? pl : -pl,
        rrr: rr,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      // Add to Firestore
      db.collection('users').doc(currentUser.uid).collection('trades').add(tradeData)
        .then((docRef) => {
          // Add to table
          const table = document.querySelector("#tradeTable tbody");
          const row = document.createElement("tr");
          
          // Format date for display
          const displayDate = new Date(date).toLocaleDateString(currentLanguage === 'fr' ? 'fr-FR' : 'en-US');
          
          row.innerHTML = `
            <td>${displayDate}</td>
            <td>${symbol}</td>
            <td><span class="badge ${type.toLowerCase()}">${type}</span></td>
            <td>${entry.toFixed(4)}</td>
            <td>${exit.toFixed(4)}</td>
            <td>${lot.toFixed(2)}</td>
            <td><span class="badge ${result}">${result === 'win' ? (currentLanguage === 'fr' ? 'Gagné' : 'Win') : (currentLanguage === 'fr' ? 'Perdu' : 'Loss')}</span></td>
            <td class="${result === 'win' ? 'profit' : 'loss'}">${result === 'win' ? '+' : '-'}${Math.abs(pl).toFixed(2)}</td>
            <td>${rr.toFixed(2)}</td>
            <td><i class="fas fa-trash" onclick="deleteTrade('${docRef.id}')" style="cursor:pointer;color:#f87171;"></i></td>
          `;
          
          table.appendChild(row);
          
          // Clear form
          document.getElementById('tradeDate').value = '';
          document.getElementById('tradeSymbol').value = '';
          document.getElementById('tradeEntry').value = '';
          document.getElementById('tradeExit').value = '';
          document.getElementById('tradeLot').value = '';
          document.getElementById('tradePL').value = '';
          document.getElementById('tradeRR').value = '';
          
          // Update stats
          trades.push(tradeData);
          allTrades = [...trades];
          updateStats();
          updatePerformanceStats();
          generateDailyFeedback();
        })
        .catch((error) => {
          console.error("Error adding trade: ", error);
          alert(currentLanguage === 'fr' ? 'Erreur lors de l\'ajout du trade' : 'Error adding trade');
        });
    }
    
    // Calcul du Risk/Reward ratio
    function calculateRR(entry, exit, result, pl) {
      if (result === 'win') {
        const risk = Math.abs(entry - (exit - pl));
        const reward = Math.abs(pl);
        return reward / risk;
      } else {
        const risk = Math.abs(pl);
        const reward = Math.abs(entry - (exit + pl));
        return reward / risk;
      }
    }

    // Supprimer un trade
    function deleteTrade(tradeId) {
      const confirmMsg = currentLanguage === 'fr' ? 'Voulez-vous vraiment supprimer ce trade ?' : 'Do you really want to delete this trade?';
      if (confirm(confirmMsg)) {
        if (currentUser) {
          // Delete from Firestore
          db.collection('users').doc(currentUser.uid).collection('trades').doc(tradeId).delete()
            .then(() => {
              // Remove from table
              const rows = document.querySelectorAll("#tradeTable tbody tr");
              for (let i = 0; i < rows.length; i++) {
                const trashIcon = rows[i].querySelector(".fa-trash");
                if (trashIcon && trashIcon.getAttribute('onclick').includes(tradeId)) {
                  rows[i].remove();
                  break;
                }
              }
              
              // Update trades array
              trades = trades.filter(trade => trade.id !== tradeId);
              allTrades = [...trades];
              
              // Update stats
              updateStats();
              updatePerformanceStats();
              generateDailyFeedback();
            })
            .catch((error) => {
              console.error("Error removing trade: ", error);
              alert(currentLanguage === 'fr' ? 'Erreur lors de la suppression' : 'Error deleting trade');
            });
        } else {
          // For non-logged users, just remove from table
          const rows = document.querySelectorAll("#tradeTable tbody tr");
          for (let i = 0; i < rows.length; i++) {
            const trashIcon = rows[i].querySelector(".fa-trash");
            if (trashIcon && trashIcon.getAttribute('onclick').includes(tradeId)) {
              rows[i].remove();
              break;
            }
          }
          
          // Update trades array
          trades = trades.filter(trade => trade.id !== tradeId);
          allTrades = [...trades];
          
          // Update stats
          updateStats();
          updatePerformanceStats();
          generateDailyFeedback();
        }
      }
    }

    // Mise à jour des statistiques
    function updateStats() {
      const rows = document.querySelectorAll("#tradeTable tbody tr");
      let totalGain = 0;
      let wins = 0;
      let totalRRR = 0;

      trades.forEach(trade => {
        totalGain += trade.pl;
        totalRRR += trade.rrr;
        if (trade.result === 'win') wins++;
      });

      // Mise à jour des statistiques
      const avgRRR = trades.length ? totalRRR / trades.length : 0;
      const winRate = trades.length ? (wins / trades.length) * 100 : 0;

      document.getElementById("totalTrades").textContent = trades.length;
      document.getElementById("winRate").textContent = `${winRate.toFixed(1)}%`;
      document.getElementById("totalProfit").textContent = `$${totalGain.toFixed(2)}`;
      document.getElementById("averageRRR").textContent = avgRRR.toFixed(2);
      document.getElementById("currentCapital").textContent = `$${(parseFloat(initialCapital) + totalGain).toFixed(2)}`;

      // Mise à jour des graphiques
      updateCharts();
    }
    
    // Mise à jour des statistiques de performance
    function updatePerformanceStats() {
      if (trades.length === 0) {
        document.getElementById("avgRiskReward").textContent = "0";
        document.getElementById("maxDrawdown").textContent = "$0";
        document.getElementById("maxDailyLoss").textContent = "$0";
        document.getElementById("maxDailyWin").textContent = "$0";
        return;
      }
      
      // Calcul du Risk/Reward moyen
      const avgRR = trades.reduce((sum, trade) => sum + trade.rrr, 0) / trades.length;
      document.getElementById("avgRiskReward").textContent = avgRR.toFixed(2);
      
      // Calcul du Max Drawdown
      let balance = parseFloat(initialCapital);
      let peak = balance;
      let maxDrawdown = 0;
      
      // Trier les trades par date
      const sortedTrades = [...trades].sort((a, b) => new Date(a.date) - new Date(b.date));
      
      // Calcul des pertes/par jour
      const dailyResults = {};
      sortedTrades.forEach(trade => {
        const date = trade.date;
        if (!dailyResults[date]) {
          dailyResults[date] = 0;
        }
        dailyResults[date] += trade.pl;
      });
      
      // Trouver le max loss/jour et max win/jour
      let maxDailyLoss = 0;
      let maxDailyWin = 0;
      
      Object.values(dailyResults).forEach(pl => {
        if (pl < maxDailyLoss) maxDailyLoss = pl;
        if (pl > maxDailyWin) maxDailyWin = pl;
      });
      
      // Calcul du drawdown
      sortedTrades.forEach(trade => {
        balance += trade.pl;
        if (balance > peak) peak = balance;
        const drawdown = peak - balance;
        if (drawdown > maxDrawdown) maxDrawdown = drawdown;
      });
      
      document.getElementById("maxDrawdown").textContent = `$${maxDrawdown.toFixed(2)}`;
      document.getElementById("maxDailyLoss").textContent = `$${maxDailyLoss.toFixed(2)}`;
      document.getElementById("maxDailyWin").textContent = `$${maxDailyWin.toFixed(2)}`;
      
      // Mise à jour du graphique quotidien
      updateDailyChart();
    }

    // Mise à jour des graphiques
    function updateCharts() {
      const wins = trades.filter(t => t.result === 'win').length;
      const losses = trades.length - wins;
      
      pieChart.data.datasets[0].data = [wins, losses];
      pieChart.update();
      
      // Mise à jour du graphique de capital
      updateCapitalChart();
    }
    
    // Mise à jour du graphique de capital
    function updateCapitalChart() {
      if (trades.length === 0) {
        capitalChart.data.labels = [];
        capitalChart.data.datasets[0].data = [];
        capitalChart.update();
        return;
      }
      
      // Trier les trades par date
      const sortedTrades = [...trades].sort((a, b) => new Date(a.date) - new Date(b.date));
      
      // Créer un tableau de balances par date
      const dates = [];
      const balances = [];
      let balance = parseFloat(initialCapital);
      
      // Ajouter le point de départ
      dates.push(new Date(sortedTrades[0].date).toLocaleDateString(currentLanguage === 'fr' ? 'fr-FR' : 'en-US'));
      balances.push(balance);
      
      sortedTrades.forEach(trade => {
        balance += trade.pl;
        dates.push(new Date(trade.date).toLocaleDateString(currentLanguage === 'fr' ? 'fr-FR' : 'en-US'));
        balances.push(balance);
      });
      
      capitalChart.data.labels = dates;
      capitalChart.data.datasets[0].data = balances;
      capitalChart.update();
    }
    
    // Mise à jour du graphique quotidien
    function updateDailyChart() {
      if (trades.length === 0) {
        dailyChart.data.labels = [];
        dailyChart.data.datasets[0].data = [];
        dailyChart.data.datasets[0].backgroundColor = [];
        dailyChart.data.datasets[0].borderColor = [];
        dailyChart.update();
        return;
      }
      
      // Calculer le profit par jour
      const dailyProfit = {};
      
      trades.forEach(trade => {
        if (!dailyProfit[trade.date]) {
          dailyProfit[trade.date] = 0;
        }
        dailyProfit[trade.date] += trade.pl;
      });
      
      // Trier par date
      const sortedDates = Object.keys(dailyProfit).sort((a, b) => new Date(a) - new Date(b));
      const dailyLabels = sortedDates.map(date => new Date(date).toLocaleDateString(currentLanguage === 'fr' ? 'fr-FR' : 'en-US'));
      const dailyData = sortedDates.map(date => dailyProfit[date]);
      
      // Créer des couleurs en fonction du profit (vert/rouge)
      const backgroundColors = dailyData.map(profit => 
        profit >= 0 ? 'rgba(74, 222, 128, 0.7)' : 'rgba(248, 113, 113, 0.7)'
      );
      const borderColors = dailyData.map(profit => 
        profit >= 0 ? 'rgba(74, 222, 128, 1)' : 'rgba(248, 113, 113, 1)'
      );
      
      dailyChart.data.labels = dailyLabels;
      dailyChart.data.datasets[0].data = dailyData;
      dailyChart.data.datasets[0].backgroundColor = backgroundColors;
      dailyChart.data.datasets[0].borderColor = borderColors;
      dailyChart.update();
    }

    // Filtrer les trades
    function filterTrades() {
      const symbolFilter = document.getElementById('symbolFilter').value.toLowerCase();
      const dateFrom = document.getElementById('dateFromFilter').value;
      const dateTo = document.getElementById('dateToFilter').value;
      const resultFilter = document.getElementById('resultFilter').value;
      
      const rows = document.querySelectorAll("#tradeTable tbody tr");
      
      rows.forEach(row => {
        const symbol = row.querySelector("td:nth-child(2)").textContent.toLowerCase();
        const date = row.querySelector("td:nth-child(1)").textContent;
        const result = row.querySelector("td:nth-child(7) span").textContent;
        
        const symbolMatch = symbol.includes(symbolFilter);
        const dateMatch = (!dateFrom || new Date(date) >= new Date(dateFrom)) && 
                         (!dateTo || new Date(date) <= new Date(dateTo));
        const resultMatch = resultFilter === 'all' || 
                          (resultFilter === 'win' && (result === 'Gagné' || result === 'Win')) || 
                          (resultFilter === 'loss' && (result === 'Perdu' || result === 'Loss'));
        
        row.style.display = symbolMatch && dateMatch && resultMatch ? "" : "none";
      });
    }
    
    // Mettre à jour le capital initial
    function updateCapital() {
      const newCapital = parseFloat(document.getElementById('initialCapital').value) || 1000;
      initialCapital = newCapital;
      
      if (currentUser) {
        saveUserData();
      } else {
        localStorage.setItem('initialCapital', newCapital);
      }
      
      updateStats();
      updateCapitalChart();
      generateDailyFeedback();
      
      alert(currentLanguage === 'fr' ? 'Capital initial mis à jour' : 'Initial capital updated');
    }
    
    // Exporter vers CSV
    function exportToCSV() {
      if (trades.length === 0) {
        alert(currentLanguage === 'fr' ? 'Aucun trade à exporter' : 'No trades to export');
        return;
      }
      
      let csv = 'Date,Symbole,Type,Entry,Exit,Lot,Resultat,P&L,R/R Ratio\n';
      
      trades.forEach(trade => {
        csv += `"${trade.date}",${trade.symbol},${trade.type},${trade.entry},${trade.exit},${trade.lot},${trade.result},${trade.pl},${trade.rrr}\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', `trading_journal_${new Date().toISOString().slice(0,10)}.csv`);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // Exporter vers Excel
    function exportToExcel() {
      if (trades.length === 0) {
        alert(currentLanguage === 'fr' ? 'Aucun trade à exporter' : 'No trades to export');
        return;
      }
      
      const wb = XLSX.utils.book_new();
      const wsData = [
        ['Date', 'Symbole', 'Type', 'Entry', 'Exit', 'Lot', 'Resultat', 'P&L', 'R/R Ratio'],
        ...trades.map(trade => [
          trade.date,
          trade.symbol,
          trade.type,
          trade.entry,
          trade.exit,
          trade.lot,
          trade.result,
          trade.pl,
          trade.rrr
        ])
      ];
      
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, 'Trading Journal');
      XLSX.writeFile(wb, `trading_journal_${new Date().toISOString().slice(0,10)}.xlsx`);
    }
    
    // Importer depuis un fichier
    function importFromFile() {
      if (!currentUser) {
        alert(currentLanguage === 'fr' 
          ? 'Veuillez vous connecter pour importer des trades' 
          : 'Please login to import trades');
        showAuthModal();
        return;
      }
      document.getElementById('fileInput').click();
    }
    
    // Gérer l'import de fichier
    function handleFileImport(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        
        // Prendre la première feuille
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);
        
        if (jsonData.length === 0) {
          alert(currentLanguage === 'fr' ? 'Aucune donnée trouvée dans le fichier' : 'No data found in file');
          return;
        }
        
        // Batch write to Firestore
        const batch = db.batch();
        const tradesRef = db.collection('users').doc(currentUser.uid).collection('trades');
        
        jsonData.forEach(row => {
          const date = row.Date || row.DATE || row.date;
          const symbol = row.Symbole || row.SYMBOL || row.symbol;
          const type = row.Type || row.TYPE || row.type;
          const entry = row.Entry || row.ENTRY || row.entry;
          const exit = row.Exit || row.EXIT || row.exit;
          const lot = row.Lot || row.LOT || row.lot;
          const result = row.Resultat || row.RESULT || row.result;
          const pl = row['P&L'] || row.PL || row.pl;
          const rr = row['R/R Ratio'] || row.RR || row.rr;
          
          if (date && symbol) {
            const tradeData = {
              date: date,
              symbol: symbol.toUpperCase(),
              type: type,
              entry: parseFloat(entry),
              exit: parseFloat(exit),
              lot: parseFloat(lot),
              result: result.toLowerCase(),
              pl: result.toLowerCase() === 'win' ? Math.abs(parseFloat(pl)) : -Math.abs(parseFloat(pl)),
              rrr: parseFloat(rr),
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            const docRef = tradesRef.doc(); // Auto-generated ID
            batch.set(docRef, tradeData);
          }
        });
        
        return batch.commit().then(() => {
          // Reload data after import
          loadUserData();
          alert(currentLanguage === 'fr' ? `${jsonData.length} trades importés avec succès` : `${jsonData.length} trades imported successfully`);
        }).catch(error => {
          console.error("Error importing trades: ", error);
          alert(currentLanguage === 'fr' ? 'Erreur lors de l\'importation' : 'Error during import');
        });
      };
      
      reader.readAsArrayBuffer(file);
      e.target.value = ''; // Reset input
    }
    
    // Basculer entre dark/light mode
    function toggleDarkMode() {
      darkMode = !darkMode;
      if (darkMode) {
        document.body.classList.remove('light-mode');
      } else {
        document.body.classList.add('light-mode');
      }
      
      if (currentUser) {
        saveUserData();
      } else {
        localStorage.setItem('darkMode', darkMode);
      }
    }
    
    // Changer la langue
    function changeLanguage(lang) {
      currentLanguage = lang;
      
      if (currentUser) {
        saveUserData();
      } else {
        localStorage.setItem('tradingLanguage', lang);
      }
      
      // Mettre à jour l'interface
      translateUI();
      
      // Mettre à jour les trades existants
      updateTradesLanguage();
    }
    
    // Traduire l'interface
    function translateUI() {
      if (currentLanguage === 'fr') {
        // Traductions françaises
        document.querySelector('#dashboard-section h3').textContent = 'AJOUTER UN TRADE';
        document.querySelector('#performance-section h1').textContent = 'ANALYSE DE PERFORMANCE';
        document.querySelector('#brokers-section h1').textContent = 'RECOMMANDATION DE BROKERS';
        document.querySelector('#settings-section h1').textContent = 'PARAMÈTRES';
        
        // Mettre à jour les textes des boutons, etc.
        document.querySelector('button[onclick="saveJournal()"]').innerHTML = '<i class="fas fa-save"></i> Sauvegarder';
        document.querySelector('button[onclick="resetJournal()"]').innerHTML = '<i class="fas fa-trash-alt"></i> Réinitialiser';
        
        // Mettre à jour les messages non connectés
        document.querySelector('#nonLoggedMessage h2').textContent = 'Connectez-vous pour accéder à votre journal';
        document.querySelector('#nonLoggedMessage p').textContent = 'Veuillez vous connecter ou créer un compte pour enregistrer et suivre vos trades.';
        document.querySelector('#nonLoggedMessage button').textContent = 'Se connecter';
        
        document.querySelector('#nonLoggedMessagePerformance h2').textContent = 'Connectez-vous pour accéder à l\'analyse de performance';
        document.querySelector('#nonLoggedMessagePerformance p').textContent = 'Veuillez vous connecter ou créer un compte pour visualiser vos statistiques de trading.';
        document.querySelector('#nonLoggedMessagePerformance button').textContent = 'Se connecter';
        
        document.querySelector('#nonLoggedMessageSettings h2').textContent = 'Connectez-vous pour accéder aux paramètres';
        document.querySelector('#nonLoggedMessageSettings p').textContent = 'Veuillez vous connecter ou créer un compte pour personnaliser votre expérience.';
        document.querySelector('#nonLoggedMessageSettings button').textContent = 'Se connecter';
      } else {
        // English translations
        document.querySelector('#dashboard-section h3').textContent = 'ADD A TRADE';
        document.querySelector('#performance-section h1').textContent = 'PERFORMANCE ANALYSIS';
        document.querySelector('#brokers-section h1').textContent = 'BROKER RECOMMENDATIONS';
        document.querySelector('#settings-section h1').textContent = 'SETTINGS';
        
        // Update button texts
        document.querySelector('button[onclick="saveJournal()"]').innerHTML = '<i class="fas fa-save"></i> Save';
        document.querySelector('button[onclick="resetJournal()"]').innerHTML = '<i class="fas fa-trash-alt"></i> Reset';
        
        // Update non-logged messages
        document.querySelector('#nonLoggedMessage h2').textContent = 'Login to access your journal';
        document.querySelector('#nonLoggedMessage p').textContent = 'Please login or create an account to save and track your trades.';
        document.querySelector('#nonLoggedMessage button').textContent = 'Login';
        
        document.querySelector('#nonLoggedMessagePerformance h2').textContent = 'Login to access performance analysis';
        document.querySelector('#nonLoggedMessagePerformance p').textContent = 'Please login or create an account to view your trading statistics.';
        document.querySelector('#nonLoggedMessagePerformance button').textContent = 'Login';
        
        document.querySelector('#nonLoggedMessageSettings h2').textContent = 'Login to access settings';
        document.querySelector('#nonLoggedMessageSettings p').textContent = 'Please login or create an account to customize your experience.';
        document.querySelector('#nonLoggedMessageSettings button').textContent = 'Login';
      }
    }
    
    // Mettre à jour la langue des trades existants
    function updateTradesLanguage() {
      const resultCells = document.querySelectorAll("#tradeTable tbody tr td:nth-child(7) span");
      
      resultCells.forEach(cell => {
        if (cell.textContent === 'Gagné' || cell.textContent === 'Win') {
          cell.textContent = currentLanguage === 'fr' ? 'Gagné' : 'Win';
        } else if (cell.textContent === 'Perdu' || cell.textContent === 'Loss') {
          cell.textContent = currentLanguage === 'fr' ? 'Perdu' : 'Loss';
        }
      });
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
      const splash = document.getElementById('splash');
      const btn = document.getElementById('enterBtn');
      const app = document.getElementById('mainApp');
      
      // Configurer les écouteurs d'authentification
      document.getElementById('showRegister').addEventListener('click', showRegisterView);
      document.getElementById('showLogin').addEventListener('click', showLoginView);
      document.getElementById('registerBtn').addEventListener('click', () => {
        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;
        const confirmPassword = document.getElementById('registerConfirmPassword').value;
        
        if (password !== confirmPassword) {
          document.getElementById('registerError').textContent = currentLanguage === 'fr' 
            ? 'Les mots de passe ne correspondent pas' 
            : 'Passwords do not match';
          return;
        }
        
        registerUser(email, password);
      });
      
      document.getElementById('loginBtn').addEventListener('click', () => {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        loginUser(email, password);
      });
      
      document.getElementById('logoutBtn').addEventListener('click', logoutUser);
      
      // Écouter les changements d'état d'authentification
      auth.onAuthStateChanged((user) => {
        if (user) {
          // User is signed in
          currentUser = user;
          document.getElementById('userEmail').textContent = user.email;
          
          // Hide auth modal if it's visible
          hideAuthModal();
          
          // Show the main app if splash screen is not shown
          if (splash.style.display === 'none') {
            app.style.display = 'flex';
            loadUserData();
          }
        } else {
          // User is signed out
          currentUser = null;
          document.getElementById('userEmail').textContent = '';
          toggleLoggedUI(false);
          
          // Show auth modal when splash screen is dismissed
          btn.addEventListener('click', () => {
            splash.style.display = 'none';
            showAuthModal();
          }, { once: true });
        }
      });
      
      // Configurer les boutons de login depuis l'application
      document.getElementById('loginFromAppBtn')?.addEventListener('click', showAuthModal);
      document.getElementById('loginFromPerformanceBtn')?.addEventListener('click', showAuthModal);
      document.getElementById('loginFromSettingsBtn')?.addEventListener('click', showAuthModal);
      
      // Fermer le message de bienvenue
      document.getElementById('closeWelcomeBtn')?.addEventListener('click', function() {
        document.getElementById('welcomeMessage').style.display = 'none';
      });
      
      // Charger les préférences locales si pas connecté
      darkMode = localStorage.getItem('darkMode') !== 'false';
      if (!darkMode) {
        document.body.classList.add('light-mode');
      }
      
      currentLanguage = localStorage.getItem('tradingLanguage') || 'fr';
      document.querySelector(`.language-option[data-lang="${currentLanguage}"]`).classList.add('active');
      
      initialCapital = parseFloat(localStorage.getItem('initialCapital')) || 1000;
      document.getElementById('initialCapital').value = initialCapital;
      
      // Configurer les datepickers
      flatpickr(".date-input", {
        dateFormat: "Y-m-d",
        defaultDate: new Date()
      });
      
      flatpickr(".date-filter", {
        dateFormat: "Y-m-d"
      });
      
      // Configurer l'écouteur de fichier
      document.getElementById('fileInput').addEventListener('change', handleFileImport);
      
      // Configurer le dark mode toggle
      document.getElementById('darkModeToggle').checked = darkMode;
      document.getElementById('darkModeToggle').addEventListener('change', toggleDarkMode);
      
      // Configurer les boutons de langue
      document.querySelectorAll('.language-option').forEach(option => {
        option.addEventListener('click', function() {
          document.querySelectorAll('.language-option').forEach(opt => opt.classList.remove('active'));
          this.classList.add('active');
          changeLanguage(this.getAttribute('data-lang'));
        });
      });

      btn.addEventListener('click', () => {
        splash.style.display = 'none';
        
        if (currentUser) {
          app.style.display = 'flex';
          initCharts();
          loadUserData();
          
          // Démarrer le carrousel de patterns émotionnels
          emotionalPatternInterval = setInterval(showNextEmotionalPattern, 60000); // 60 secondes
          
          // Générer le feedback quotidien
          generateDailyFeedback();
        } else {
          showAuthModal();
        }
      });

      // Navigation
      document.querySelectorAll('.sidebar i').forEach(icon => {
        icon.addEventListener('click', function() {
          const section = this.getAttribute('data-section');
          if (section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(section + '-section').classList.add('active');
            
            document.querySelectorAll('.sidebar i').forEach(i => 
              i.classList.remove('active'));
            this.classList.add('active');
          }
        });
      });
      
      // Auto-calculate RR when PL changes
      document.getElementById('tradePL').addEventListener('input', function() {
        const entry = parseFloat(document.getElementById('tradeEntry').value) || 0;
        const exit = parseFloat(document.getElementById('tradeExit').value) || 0;
        const result = document.getElementById('tradeResult').value;
        const pl = parseFloat(this.value) || 0;
        
        if (entry && exit && pl) {
          const rr = calculateRR(entry, exit, result, pl);
          document.getElementById('tradeRR').value = rr.toFixed(2);
        }
      });
      
      // Auto-calculate PL when Exit changes
      document.getElementById('tradeExit').addEventListener('input', function() {
        const entry = parseFloat(document.getElementById('tradeEntry').value) || 0;
        const exit = parseFloat(this.value) || 0;
        const lot = parseFloat(document.getElementById('tradeLot').value) || 0;
        const type = document.getElementById('tradeType').value;
        
        if (entry && exit && lot) {
          let pl = 0;
          if (type === 'Buy') {
            pl = (exit - entry) * lot * 100000; // Simplified calculation for forex
          } else {
            pl = (entry - exit) * lot * 100000;
          }
          
          document.getElementById('tradePL').value = Math.abs(pl).toFixed(2);
          document.getElementById('tradeResult').value = pl >= 0 ? 'win' : 'loss';
          
          // Calculate RR
          const result = document.getElementById('tradeResult').value;
          const rr = calculateRR(entry, exit, result, pl);
          document.getElementById('tradeRR').value = rr.toFixed(2);
        }
      });
    });
  </script>
</body>
</html>