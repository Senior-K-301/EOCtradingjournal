<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>Journal de Trading – EOC Dashboard</title>
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <!-- Google Sign-In -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root{
      --bg:#0c1022; --panel:#141a34; --muted:#7a84a1; --text:#e8e9ff;
      --accent:#675CFF; --accent-2:#FF3D71; --accent-3:#00C6FF;
      --good:#28e98c; --bad:#ff6b6b; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
      --positive: #4a7bff; --negative: #ff4d4d;
    }
    [data-theme="light"]{
      --bg:#f6f7fb; --panel:#ffffff; --text:#0d1030; --muted:#6b7391;
      --shadow:0 10px 25px rgba(0,0,0,.08);
      --positive: #2d5aff; --negative: #ff3333;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--text);
      background:radial-gradient(1200px 800px at 10% -20%, #1d1f4a 0%, transparent 60%), radial-gradient(900px 600px at 100% 0%, #1a1b3d 0%, transparent 60%), var(--bg); overflow-x: hidden; overflow-y: auto;}
    [data-theme="light"] body, [data-theme="light"]{background:var(--bg)}
    
    .app{display:grid; grid-template-columns: 90px 1fr; grid-template-rows: auto 1fr; height:100vh; gap:18px; padding:18px}
    .sidebar{grid-row:1 / span 2; grid-column:1; background:rgba(255,255,255,.02); border:1px solid rgba(255,255,255,.06); border-radius:24px; backdrop-filter: blur(8px); display:flex; flex-direction:column; align-items:center; padding:14px 10px; gap:14px}
    [data-theme="light"] .sidebar{background:#fff}
    .topbar{grid-column:2; grid-row:1; display:flex; align-items:center; gap:16px; flex-wrap: wrap;}
    .main{grid-column:2; grid-row:2; overflow:auto; padding-right:4px}

    .brand{width:48px;height:48px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(140deg,var(--accent),var(--accent-2)); color:#fff; font-weight:800; letter-spacing:1px; box-shadow:0 10px 25px rgba(103,92,255,.35)}
    .nav{display:flex; flex-direction:column; gap:10px; margin-top:4px}
    .nav button{all:unset; cursor:pointer; width:52px; height:52px; display:grid; place-items:center; border-radius:14px; color:#9aa3c2; transition:.25s; position:relative}
    .nav button:hover{color:#fff; background:rgba(255,255,255,.05)}
    .nav button.active{color:#fff; background:linear-gradient(140deg, rgba(103,92,255,.25), rgba(0,198,255,.18)); box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}
    .nav-text {font-size: 10px; text-align: center; margin-top: 4px; color: var(--muted);}
    .logout{margin-top:auto}

    .topbar .tabset{display:flex; gap:18px; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.06); padding:8px; border-radius:999px; flex-wrap: wrap;}
    .topbar .tab{padding:8px 14px; border-radius:999px; color:#b5bdd8; cursor:pointer; transition:.2s}
    .topbar .tab.active{background:linear-gradient(140deg, rgba(103,92,255,.25), rgba(0,198,255,.25)); color:#fff}
    .search{flex:1; display:flex; align-items:center; gap:10px; background:rgba(255,255,255,.02); border:1px solid rgba(255,255,255,.06); padding:10px 14px; border-radius:14px; min-width: 200px;}
    .search input{all:unset; flex:1; color:var(--text)}
    .actions{display:flex; align-items:center; gap:10px; flex-wrap: wrap;}
    .actions .icon{width:44px; height:44px; display:grid; place-items:center; border-radius:12px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06); color:#c7ccef; position:relative; cursor:pointer}
    .badge{position:absolute; top:6px; right:6px; background:var(--accent-2); color:#fff; line-height:1; font-size:10px; padding:4px 6px; border-radius:999px}
    .avatar{width:44px;height:44px;border-radius:14px; background:linear-gradient(140deg,var(--accent-2),var(--accent-3)); display:grid; place-items:center; font-weight:700; cursor:pointer}

    .grid{display:grid; grid-template-columns: 1.2fr 1fr; gap:18px}
    .cards{display:grid; grid-template-columns: repeat(4, 1fr); gap:18px}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); box-shadow:var(--shadow)}
    [data-theme="light"] .panel{background:#fff; border:1px solid rgba(13,16,48,.08)}
    .panel.pad{padding:18px}

    .kpi{display:flex; flex-direction:column; gap:14px}
    .kpi .ring{--val:50; width:110px;height:110px; border-radius:50%; background:
      radial-gradient(farthest-side, #0e1230 calc(100% - 16px), transparent 0 100%),
      conic-gradient(var(--accent) calc(var(--val) * 1%), rgba(255,255,255,.08) 0);
      display:grid; place-items:center; margin:auto}
    [data-theme="light"] .kpi .ring{background:
      radial-gradient(farthest-side, #fff calc(100% - 16px), transparent 0 100%),
      conic-gradient(var(--accent) calc(var(--val) * 1%), rgba(13,16,48,.08) 0);
    }
    .kpi .ring .v{background:#0e1230; width:78px;height:78px;border-radius:50%; display:grid;place-items:center; font-weight:800; color:#fff}
    [data-theme="light"] .kpi .ring .v{background:#fff; color:#0d1030}
    .kpi .title{font-size:13px;color:#b2bbd8; text-transform:uppercase; letter-spacing:.08em}
    .kpi .num{font-size:22px; font-weight:800}

    .chart{height:240px; width: 100%; min-width: 0; /* Ajout pour éviter l'expansion */}
    .chart-container {position: relative; height: 240px; width: 100%; min-width: 0; /* Conteneur pour les graphiques */}
    .legend{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .dot{width:10px;height:10px;border-radius:50%}

    .stack{display:grid; gap:18px}
    .form{display:grid; grid-template-columns: repeat(6, 1fr); gap:12px}
    .form .field{display:flex; flex-direction:column; gap:6px}
    .label{font-size:12px; color:#9aa3c2}
    .input, select, textarea{width:100%; background:rgba(255,255,255,.04); color:var(--text); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px}
    [data-theme="light"] .input, [data-theme="light"] select, [data-theme="light"] textarea{background:#f2f4fb; border-color:rgba(13,16,48,.08)}
    .btn{all:unset; cursor:pointer; padding:10px 14px; border-radius:12px; background:linear-gradient(140deg,var(--accent),var(--accent-3)); color:#fff; font-weight:700; text-align:center}
    .btn.ghost{background:transparent; border:1px solid rgba(255,255,255,.12); color:#d6dbff}
    [data-theme="light"] .btn.ghost{color:#0d1030; border-color:rgba(13,16,48,.12)}

    table{width:100%; border-collapse:collapse}
    th,td{padding:12px 10px; text-align:left}
    thead th{font-size:12px; color:#aeb6d4; font-weight:600; border-bottom:1px solid rgba(255,255,255,.08)}
    tbody td{border-bottom:1px dashed rgba(255,255,255,.08)}

/* Styles pour les pastilles de résultat */
.pill {
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 600;
  text-align: center;
  display: inline-block;
}

.pill.win {
  background: rgba(40, 233, 140, 0.15);
  color: var(--good);
}

.pill.loss {
  background: rgba(255, 107, 107, 0.15);
  color: var(--bad);
}

    /* Auth modal */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:50}
    .modal .card{width:min(560px, 96vw); background:var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:20px; box-shadow:var(--shadow)}
    .modal h2{margin:0 0 10px}

    /* Timezone selector */
    .timezone-selector {display: flex; align-items: center; gap: 8px; margin-right: 10px; color: var(--muted); font-size: 12px;}
    .timezone-selector select {width: auto; padding: 6px 8px; font-size: 12px;}

    /* Calendar styles */
    .calendar-nav {display: flex; gap: 10px; margin-bottom: 14px;}
    .calendar-nav button {padding: 8px 12px;}
  
  .calendar-day.positive {
   background: rgba(74, 123, 255, 0.2) !important;
   box-shadow: 0 0 0 2px rgba(74, 123, 255, 0.3) !important;}

  .calendar-day.negative {
  background: rgba(255, 77, 77, 0.2) !important;
  box-shadow: 0 0 0 2px rgba(255, 77, 77, 0.3) !important;}

  .calendar-day .day-trades {
  font-size: 9px !important;
  color: var(--muted) !important;
  margin-top: 2px !important;}

    /* User menu */
    .user-menu {position: absolute; top: 60px; right: 10px; background: var(--panel); border-radius: 12px; padding: 10px; box-shadow: var(--shadow); z-index: 100; display: none; flex-direction: column; gap: 8px; min-width: 200px; border: 1px solid rgba(255,255,255,.08);}
    .user-menu button {all: unset; padding: 10px; cursor: pointer; border-radius: 8px;}
    .user-menu button:hover {background: rgba(255,255,255,.05);}

    /* Language selector */
    .language-selector {display: flex; gap: 10px; align-items: center;}

    /* Digital clock */
    .digital-clock {display: flex; align-items: center; gap: 8px; margin-right: 10px; color: var(--muted); font-size: 14px; font-weight: 600;}
    .digital-clock i {color: var(--accent);}
    .led-clock {font-family: 'Courier New', monospace; background: #300; color: #f00; padding: 4px 8px; border-radius: 4px; text-shadow: 0 0 5px #f00;}

    .calendar-day {
  padding: 10px;
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
  text-align: center;
  min-height: 60px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  transition: all 0.2s;
}

   .calendar-day:hover {
  transform: translateY(-2px);
}

    .calendar-day.positive {
  background: rgba(74, 123, 255, 0.2);
  box-shadow: 0 0 0 2px rgba(74, 123, 255, 0.3);
}

    .calendar-day.negative {
  background: rgba(255, 77, 77, 0.2);
  box-shadow: 0 0 0 2px rgba(255, 77, 77, 0.3);
}

   .calendar-day .day-number {
  font-weight: bold;
  font-size: 18px;
}

   .calendar-day .day-pnl {
  font-size: 10px;
  margin-top: 4px;
  font-weight: 600;
}
  
    /* Gauge chart styles */
    .gauge-container {position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center;}
    .gauge-value {position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; font-weight: bold; color: var(--text);}

    /* Notification toast */
    .toast {position: fixed; bottom: 20px; right: 20px; background: var(--panel); color: var(--text); padding: 12px 20px; border-radius: 8px; box-shadow: var(--shadow); z-index: 1000; display: flex; align-items: center; gap: 10px; transform: translateY(100px); opacity: 0; transition: all 0.3s ease;}
    .toast.show {transform: translateY(0); opacity: 1;}
    .toast i {font-size: 18px;}
    .toast.success i {color: var(--good);}
    .toast.info i {color: var(--accent);}
    .toast.warning i {color: var(--bad);}

    /* Notes display */
    .notes-history {margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.08); padding-top: 15px;}
    .note-item {background: rgba(255,255,255,0.03); border-radius: 8px; padding: 12px; margin-bottom: 10px;}
    .note-date {font-size: 12px; color: var(--muted); margin-bottom: 5px;}
    .note-content {white-space: pre-wrap;}

    /* Password validation */
    .password-strength {height: 6px; border-radius: 3px; margin-top: 5px; background: rgba(255,255,255,0.1); overflow: hidden;}
    .password-strength-bar {height: 100%; width: 0%; transition: width 0.3s;}
    .password-strength.weak .password-strength-bar {background: var(--bad); width: 33%;}
    .password-strength.medium .password-strength-bar {background: orange; width: 66%;}
    .password-strength.strong .password-strength-bar {background: var(--good); width: 100%;}
    .password-rules {font-size: 12px; color: var(--muted); margin-top: 5px;}

    /* Profile edit modal */
    .profile-modal {display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;}
    .profile-modal-content {background: var(--panel); padding: 20px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: var(--shadow);}
    .profile-modal h3 {margin-top: 0;}
    .profile-modal .field {margin-bottom: 15px;}
    .profile-modal .buttons {display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;}

    /* Broker list styles */
    .broker-list {display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px; margin-top: 16px;}
    .broker-card {background: rgba(255,255,255,0.03); border-radius: 12px; padding: 16px; transition: all 0.3s ease;}
    .broker-card:hover {transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.2);}
    .broker-card h3 {margin: 0 0 10px 0; font-size: 16px;}
    .broker-card a {display: inline-block; margin-top: 12px; padding: 8px 16px; background: var(--accent); color: white; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 14px;}
    .broker-card a:hover {background: var(--accent-3);}

    /* Import/Export styles */
    .import-export-options {display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; margin-top: 16px;}
    .import-export-card {background: rgba(255,255,255,0.03); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s ease;}
    .import-export-card:hover {transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.2);}
    .import-export-card i {font-size: 32px; margin-bottom: 12px; color: var(--accent);}
    .import-export-card h3 {margin: 0 0 10px 0; font-size: 16px;}

    /* Statistics styles */
    .stats-grid {display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 18px;}
    .stat-card {background: rgba(255,255,255,0.03); border-radius: 12px; padding: 16px;}
    .stat-card h3 {margin: 0 0 12px 0; font-size: 14px; color: var(--muted);}
    .stat-value {font-size: 24px; font-weight: 800; margin-bottom: 8px;}
    .stat-details {font-size: 13px; color: var(--muted);}

    /* Detailed stats styles */
    .detailed-stats {display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px; margin-top: 20px;}
    .stat-item {background: rgba(255,255,255,0.03); border-radius: 12px; padding: 16px;}
    .stat-item h4 {margin: 0 0 10px 0; font-size: 14px; color: var(--muted);}
    .stat-item .value {font-size: 20px; font-weight: 700;}

    /* Report styles */
    .report-options {display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px; margin-top: 20px;}
    .report-card {background: rgba(255,255,255,0.03); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s ease;}
    .report-card:hover {transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.2);}
    .report-card i {font-size: 32px; margin-bottom: 12px; color: var(--accent);}
    .report-card h3 {margin: 0 0 10px 0; font-size: 16px;}

    /* Responsive adjustments */
    @media (max-width: 1200px) { 
      .cards { grid-template-columns: repeat(2, 1fr); } 
      .grid { grid-template-columns: 1fr; } 
    }
    
    @media (max-width: 900px) { 
      .app { grid-template-columns: 72px 1fr; } 
      .form { grid-template-columns: repeat(2, 1fr); } 
      .topbar { flex-direction: column; align-items: flex-start; }
      .search { width: 100%; margin: 10px 0; }
    }
    
    @media (max-width: 768px) {
      .app { grid-template-columns: 1fr; grid-template-rows: auto auto 1fr; padding: 10px; }
      .sidebar { grid-row: 1; grid-column: 1; flex-direction: row; height: auto; width: 100%; padding: 10px; }
      .nav { flex-direction: row; margin-top: 0; }
      .logout { margin-top: 0; margin-left: auto; }
      .topbar { grid-row: 2; grid-column: 1; }
      .main { grid-row: 3; grid-column: 1; }
      
      .cards { grid-template-columns: 1fr; }
      .form { grid-template-columns: 1fr; }
      
      .kpi .ring { width: 90px; height: 90px; }
      .kpi .ring .v { width: 60px; height: 60px; }
    }
    
    @media (max-width: 480px) {
      .sidebar { justify-content: space-between; }
      .brand { width: 40px; height: 40px; font-size: 12px; }
      .nav button { width: 44px; height: 44px; }
      .logout.icon { width: 44px; height: 44px; }
      
      .topbar .tabset { width: 100%; justify-content: center; }
      .actions { width: 100%; justify-content: space-between; }
      
      .panel.pad { padding: 12px; }
      .chart { height: 200px; }
      .chart-container { height: 200px; }
    }

    /* Correction pour les conteneurs de graphiques */
    .panel > .chart-container,
    .panel > canvas.chart {
      max-width: 100%;
      min-width: 0; /* Important pour éviter l'expansion */
    }

    /* Correction pour les grilles contenant des graphiques */
    .grid, .cards {
      min-width: 0; /* Important pour éviter l'expansion */
    }

    /* Correction pour les panels contenant des graphiques */
    .panel {
      overflow: hidden; /* Empêche le débordement */
      min-width: 0; /* Important pour éviter l'expansion */
    }

    /* Correction spécifique pour les graphiques Chart.js */
    canvas.chart {
      display: block; /* Évite l'espace blanc sous le canvas */
      max-width: 100% !important;
      width: 100% !important;
      height: 240px !important;
    }

    /* Correction pour le conteneur principal */
    .main {
      min-width: 0; /* Important pour éviter l'expansion */
    }

    /* Correction pour les sections */
    section {
      min-width: 0; /* Important pour éviter l'expansion */
    }
  </style>
</head>
<body>
<div class="app" id="app" style="display: none;">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">EOC</div>
    <div class="nav" id="nav">
      <button class="nav-btn active" data-target="overview" title="Dashboard">
        <i class="fa-solid fa-gauge-high"></i>
        <div class="nav-text">Dashboard</div>
      </button>
      <button class="nav-btn" data-target="journal" title="Journal">
        <i class="fa-solid fa-pen-nib"></i>
        <div class="nav-text">Journal</div>
      </button>
      <button class="nav-btn" data-target="analytics" title="Performance">
        <i class="fa-solid fa-chart-line"></i>
        <div class="nav-text">Stats</div>
      </button>
      <button class="nav-btn" data-target="calendar" title="Calendrier">
        <i class="fa-solid fa-calendar"></i>
        <div class="nav-text">Calendrier</div>
      </button>
      <button class="nav-btn" data-target="notes" title="Notes">
        <i class="fa-solid fa-note-sticky"></i>
        <div class="nav-text">Notes</div>
      </button>
      <button class="nav-btn" data-target="settings" title="Réglages">
        <i class="fa-solid fa-gear"></i>
        <div class="nav-text">Réglages</div>
      </button>
    </div>
    <button id="logoutBtn" class="logout icon" title="Déconnexion"><i class="fa-solid fa-right-from-bracket"></i></button>
  </aside>
  
  <!-- TOPBAR -->
  <header class="topbar">
    <div class="tabset">
      <div class="tab active" data-target="broker">BROKER</div>
      <div class="tab" data-target="charger">CHARGER</div>
      <div class="tab" data-target="statistiques">STATISTIQUES</div>
      <div class="tab" data-target="rapports">RAPPORTS</div>
    </div>
    <div class="search"><i class="fa-solid fa-magnifying-glass"></i><input id="search" placeholder="Rechercher un actif, une note…"/></div>
    <div class="actions">
      <div class="digital-clock" id="digitalClock">
        <i class="fa-solid fa-clock"></i>
        <span id="clockTime" class="led-clock">00:00:00</span>
      </div>
      <div class="timezone-selector">
        <select id="gmtSelector">
          <option value="-12">GMT-12</option>
          <option value="-11">GMT-11</option>
          <option value="-10">GMT-10</option>
          <option value="-9">GMT-9</option>
          <option value="-8">GMT-8</option>
          <option value="-7">GMT-7</option>
          <option value="-6">GMT-6</option>
          <option value="-5">GMT-5</option>
          <option value="-4">GMT-4</option>
          <option value="-3">GMT-3</option>
          <option value="-2">GMT-2</option>
          <option value="-1">GMT-1</option>
          <option value="0" selected>GMT+0</option>
          <option value="+1">GMT+1</option>
          <option value="+2">GMT+2</option>
          <option value="+3">GMT+3</option>
          <option value="+4">GMT+4</option>
          <option value="+5">GMT+5</option>
          <option value="+6">GMT+6</option>
          <option value="+7">GMT+7</option>
          <option value="+8">GMT+8</option>
          <option value="+9">GMT+9</option>
          <option value="+10">GMT+10</option>
          <option value="+11">GMT+11</option>
          <option value="+12">GMT+12</option>
        </select>
      </div>
      <div class="icon" title="Notifications"><i class="fa-regular fa-bell"></i><span class="badge" id="notifCount">3</span></div>
      <div class="icon" id="themeToggle" title="Mode clair/sombre"><i class="fa-solid fa-circle-half-stroke"></i></div>
      <div class="avatar" id="avatar">YOU</div>
    </div>
    <div class="user-menu" id="userMenu">
      <button id="editProfileBtn"><i class="fa-solid fa-user-pen"></i> Modifier le profil</button>
      <button id="changeEmailBtn"><i class="fa-solid fa-envelope"></i> Modifier l'email</button>
      <button id="resetPasswordBtn"><i class="fa-solid fa-key"></i> Réinitialiser le mot de passe</button>
    </div>
  </header>
  
  <!-- MAIN -->
  <main class="main">
    <section id="overview" class="stack">
      <h2 style="margin: 0 0 18px 0; display: flex; align-items: center; gap: 10px;">
        <i class="fa-solid fa-gauge-high" style="color: var(--accent);"></i>
        Tableau de Bord
      </h2>
      
      <!-- KPIs -->
      <div class="cards">
        <div class="panel pad kpi"><div class="title">Taux de réussite</div><div class="ring" id="ring-win" style="--val:0"><div class="v"><span id="kpi-win">0%</span></div></div></div>
        <div class="panel pad kpi"><div class="title">Objectif mensuel</div><div class="ring" id="ring-month" style="--val:0"><div class="v"><span id="kpi-month">0%</span></div></div></div>
        <div class="panel pad">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px"><div class="title">Ce mois</div><button class="btn ghost" id="checkMonth">Check</button></div>
          <div class="stack">
            <div>
              <div style="display:flex; justify-content:space-between; font-weight:700"><span>Trades gagnants</span><span id="mWin">0%</span></div>
              <div class="hbar"><span id="barWin" style="background:linear-gradient(90deg,var(--positive),#4a7bff); width:0%"></span></div>
            </div>
            <div>
              <div style="display:flex; justify-content:space-between; font-weight:700"><span>Trades perdants</span><span id="mLoss">0%</span></div>
              <div class="hbar"><span id="barLoss" style="background:linear-gradient(90deg,var(--negative),#ff4d4d); width:0%"></span></div>
            </div>
          </div>
        </div>
        <div class="panel pad">
          <div class="title">Performance par mois</div>
          <div class="chart-container">
            <canvas id="miniBars" class="chart"></canvas>
          </div>
        </div>
      </div>
      
      <div class="grid">
        <div class="panel pad">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px">
            <div class="title">Indicateur de Greed</div>
          </div>
          <div class="gauge-container">
            <canvas id="gaugeChart" class="chart"></canvas>
            <div class="gauge-value" id="gaugeValue">0%</div>
          </div>
        </div>
        <div class="panel pad">
          <div class="title">Gagnants vs Perdants</div>
          <div class="chart-container" style="max-width: 250px; margin: 0 auto;">
            <canvas id="pie" class="chart"></canvas>
          </div>
        </div>
      </div>
    </section>

  <section id="journal" class="stack" style="display: none;">
  <h2 style="margin: 0 0 18px 0; display: flex; align-items: center; gap: 10px;">
    <i class="fa-solid fa-pen-nib" style="color: var(--accent);"></i>
    Journal de Trading
  </h2>
  
  <div class="panel pad">
    <h3 style="margin:0 0 14px 0">Ajouter un trade</h3>
    <div class="form">
      <div class="field">
        <label class="label">Date</label>
        <input id="tDate" class="input" type="date" required/>
      </div>
      <div class="field">
        <label class="label">Actif</label>
        <input id="tAsset" class="input" placeholder="EUR/USD, AAPL…" required/>
      </div>
      <div class="field">
        <label class="label">Type</label>
        <select id="tType" class="input" required>
          <option value="Buy">Buy</option>
          <option value="Sell">Sell</option>
        </select>
      </div>
      <div class="field">
        <label class="label">Prix d'entrée</label>
        <input id="tEntry" class="input" type="number" step="0.00001" placeholder="1.2345" required/>
      </div>
      <div class="field">
        <label class="label">Prix de sortie</label>
        <input id="tExit" class="input" type="number" step="0.00001" placeholder="1.2456" required/>
      </div>
      <div class="field">
        <label class="label">Lot</label>
        <input id="tLot" class="input" type="number" step="0.01" value="1.00" required/>
      </div>
      <div class="field">
        <label class="label">Résultat</label>
        <select id="tStatus" class="input" required>
          <option value="Win">Win</option>
          <option value="Loss">Loss</option>
        </select>
      </div>
      <div class="field">
        <label class="label">P&L (€)</label>
        <input id="tResult" class="input" type="number" step="0.01" placeholder="+120.50" required/>
      </div>
      <div class="field">
        <label class="label">Note</label>
        <textarea id="tNote" class="input" placeholder="Notes sur le trade…" style="resize:vertical"></textarea>
      </div>
      <div class="field" style="grid-column: span 2;">
        <label class="label">&nbsp;</label>
        <button class="btn" id="addTrade">Ajouter le trade</button>
      </div>
    </div>
  </div>
  
  <div class="panel pad">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px">
      <h3 style="margin:0">Historique des trades</h3>
      <button id="resetJournal" class="btn ghost" style="background: rgba(255, 61, 113, 0.15); color: var(--accent-2);">
        <i class="fa-solid fa-trash"></i> Réinitialiser
      </button>
    </div>
    <div style="overflow-x: auto;">
      <table id="tradesTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Actif</th>
            <th>Type</th>
            <th>Entrée</th>
            <th>Sortie</th>
            <th>Lot</th>
            <th>Résultat</th>
            <th>P&L</th>
            <th>RR</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody id="tradesList">
          <!-- Les trades seront ajoutés ici dynamiquement -->
        </tbody>
      </table>
    </div>
  </div>
</section>

    <section id="analytics" class="stack" style="display: none;">
      <h2 style="margin: 0 0 18px 0; display: flex; align-items: center; gap: 10px;">
        <i class="fa-solid fa-chart-line" style="color: var(--accent);"></i>
        Statistiques de Performance
      </h2>
      
      <div class="panel pad">
        <div class="title">Évolution du capital</div>
        <div class="chart-container">
          <canvas id="equityChart" class="chart"></canvas>
        </div>
      </div>
      
      <div class="grid">
        <div class="panel pad">
          <div class="title">Performance par actif</div>
          <div class="chart-container">
            <canvas id="assetsChart" class="chart"></canvas>
          </div>
        </div>
        <div class="panel pad">
          <div class="title">Rendements mensuels</div>
          <div class="chart-container">
            <canvas id="monthlyChart" class="chart"></canvas>
          </div>
        </div>
      </div>
    </section>

    <section id="calendar" class="stack" style="display: none;">
  <h2 style="margin: 0 0 18px 0; display: flex; align-items: center; gap: 10px;">
    <i class="fa-solid fa-calendar" style="color: var(--accent);"></i>
    Calendrier des Performances
  </h2>
  
  <div class="panel pad">
    <div class="calendar-nav">
      <button class="btn ghost" id="prevMonth"><i class="fa-solid fa-chevron-left"></i></button>
      <h3 id="currentMonth" style="margin:0; flex:1; text-align:center">Janvier 2023</h3>
      <button class="btn ghost" id="nextMonth"><i class="fa-solid fa-chevron-right"></i></button>
    </div>
    
    <div id="calendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 10px;">
      <!-- En-têtes des jours -->
      <div style="text-align: center; padding: 8px 0; font-weight: 600; color: var(--muted);">Lun</div>
      <div style="text-align: center; padding: 8px 0; font-weight: 600; color: var(--muted);">Mar</div>
      <div style="text-align: center; padding: 8px 0; font-weight: 600; color: var(--muted);">Mer</div>
      <div style="text-align: center; padding: 8px 0; font-weight: 600; color: var(--muted);">Jeu</div>
      <div style="text-align: center; padding: 8px 0; font-weight: 600; color: var(--muted);">Ven</div>
      <div style="text-align: center; padding: 8px 0; font-weight: 600; color: var(--muted);">Sam</div>
      <div style="text-align: center; padding: 8px 0; font-weight: 600; color: var(--muted);">Dim</div>
      
      <!-- Les jours du mois seront ajoutés ici par JavaScript -->
    </div>
  </div>
</section>

    <section id="notes" class="stack" style="display: none;">
      <h2 style="margin: 0 0 18px 0; display: flex; align-items: center; gap: 10px;">
        <i class="fa-solid fa-note-sticky" style="color: var(--accent);"></i>
        Notes de Trading
      </h2>
      
      <div class="panel pad">
        <h3 style="margin:0 0 14px 0">Nouvelle note</h3>
        <div class="form">
          <div class="field" style="grid-column: span 3;">
            <label class="label">Titre</label>
            <input id="noteTitle" class="input" placeholder="Titre de la note"/>
          </div>
          <div class="field" style="grid-column: span 3;">
            <label class="label">Catégorie</label>
            <select id="noteCategory" class="input">
              <option>Analyse</option>
              <option>Stratégie</option>
              <option>Erreur</option>
              <option>Objectif</option>
              <option>Rappel</option>
            </select>
          </div>
          <div class="field" style="grid-column: span 6;">
            <label class="label">Contenu</label>
            <textarea id="noteContent" class="input" rows="4" placeholder="Écrivez vos observations, analyses ou réflexions ici..."></textarea>
          </div>
          <div class="field" style="grid-column: span 2;">
            <button id="saveNote" class="btn">Enregistrer</button>
          </div>
        </div>
      </div>
      
      <div class="notes-history">
        <h3 style="margin:0 0 14px 0">Notes précédentes</h3>
        <div id="notesList">
          <!-- Notes will be inserted here by JavaScript -->
        </div>
      </div>
    </section>

    <section id="settings" class="stack" style="display: none;">
      <h2 style="margin: 0 0 18px 0; display: flex; align-items: center; gap: 10px;">
        <i class="fa-solid fa-gear" style="color: var(--accent);"></i>
        Paramètres
      </h2>
      
      <div class="panel pad">
        <h3 style="margin:0 0 14px 0">Configuration du compte</h3>
        <div class="form">
          <div class="field" style="grid-column: span 3;">
            <label class="label">Capital initial (€)</label>
            <input id="initialCapital" class="input" type="number" value="10000"/>
          </div>
          <div class="field" style="grid-column: span 3;">
            <label class="label">Devise</label>
            <select id="currency" class="input">
              <option>EUR</option>
              <option>USD</option>
              <option>GBP</option>
              <option>CHF</option>
              <option>JPY</option>
            </select>
          </div>
          <div class="field" style="grid-column: span 2;">
            <label class="label">Mode d'affichage</label>
            <select id="themeMode" class="input">
              <option value="dark">Sombre</option>
              <option value="light">Clair</option>
              <option value="auto">Automatique</option>
            </select>
          </div>
          <div class="field" style="grid-column: span 2;">
            <label class="label">Langue</label>
            <select id="language" class="input">
              <option value="fr">Français</option>
              <option value="en">English</option>
            </select>
          </div>
          <div class="field" style="grid-column: span 2;">
            <label class="label">Fuseau horaire</label>
            <select id="timezone" class="input">
              <option value="auto">Automatique</option>
              <option value="-12">GMT-12</option>
              <option value="-11">GMT-11</option>
              <option value="-10">GMT-10</option>
              <option value="-9">GMT-9</option>
              <option value="-8">GMT-8</option>
              <option value="-7">GMT-7</option>
              <option value="-6">GMT-6</option>
              <option value="-5">GMT-5</option>
              <option value="-4">GMT-4</option>
              <option value="-3">GMT-3</option>
              <option value="-2">GMT-2</option>
              <option value="-1">GMT-1</option>
              <option value="0" selected>GMT+0</option>
              <option value="+1">GMT+1</option>
              <option value="+2">GMT+2</option>
              <option value="+3">GMT+3</option>
              <option value="+4">GMT+4</option>
              <option value="+5">GMT+5</option>
              <option value="+6">GMT+6</option>
              <option value="+7">GMT+7</option>
              <option value="+8">GMT+8</option>
              <option value="+9">GMT+9</option>
              <option value="+10">GMT+10</option>
              <option value="+11">GMT+11</option>
              <option value="+12">GMT+12</option>
            </select>
          </div>
          <div class="field" style="grid-column: span 6;">
            <button id="saveSettings" class="btn">Enregistrer les paramètres</button>
          </div>
        </div>
      </div>
    </section>

   <!-- SECONDARY NAVIGATION SECTIONS -->
<section id="broker" class="stack" style="display: none;">
  <h2 style="margin: 0 0 18px 0; display: flex; align-items: center; gap: 10px;">
    <i class="fa-solid fa-building-columns" style="color: var(--accent);"></i>
    Brokers Recommandés
  </h2>
  
  <div class="panel pad">
    <p style="margin: 0 0 16px 0; color: var(--muted);">Voici une sélection de brokers recommandés avec lesquels nous travaillons. En utilisant nos liens de parrainage, vous nous soutenez sans frais supplémentaires pour vous.</p>
    
    <div class="broker-list">
      <div class="broker-card">
        <h3>EXNESS</h3>
        <p style="margin: 0; font-size: 14px; color: var(--muted);">Spreads bas, exécution rapide et plateforme de trading avancée pour le Forex et les CFD.</p>
        <a href="https://one.exnesstrack.org/a/i911hyordj" target="_blank">Ouvrir un compte</a>
      </div>
      
      <div class="broker-card">
        <h3>LITEFINANCE</h3>
        <p style="margin: 0; font-size: 14px; color: var(--muted);">Conditions de trading compétitives, analyse technique avancée et outils de trading professionnels.</p>
        <a href="https://www.litefinance.org/?uid=114959820" target="_blank">Ouvrir un compte</a>
      </div>
      
      <div class="broker-card">
        <h3>HEADWAY</h3>
        <p style="margin: 0; font-size: 14px; color: var(--muted);">Cashback, conditions de trading favorables et support multilingue 24/7.</p>
        <a href="https://headway.partners/user/signup?hwp=2107f0" target="_blank">Ouvrir un compte</a>
      </div>
      
      <div class="broker-card">
        <h3>FBS</h3>
        <p style="margin: 0; font-size: 14px; color: var(--muted);">Bonus de bienvenue, leverage élevé et large sélection d'instruments de trading.</p>
        <a href="https://fbs.partners?ibl=891392&ibp=25515221" target="_blank">Ouvrir un compte</a>
      </div>
      
      <div class="broker-card">
        <h3>ROBOFOREX</h3>
        <p style="margin: 0; font-size: 14px; color: var(--muted);">Multiples plateformes, copytrading et conditions adaptées aux traders débutants et expérimentés.</p>
        <a href="https://my.roboforex.com/en/?a=eqylm" target="_blank">Ouvrir un compte</a>
      </div>
    </div>
  </div>
</section>

    <section id="charger" class="stack" style="display: none;">
      <h2 style="margin: 0 0 18px 0; display: flex; align-items: center; gap: 10px;">
        <i class="fa-solid fa-file-import" style="color: var(--accent);"></i>
        Importer / Exporter des Données
      </h2>
      
      <div class="panel pad">
        <div class="import-export-options">
          <div class="import-export-card">
            <i class="fa-solid fa-file-csv"></i>
            <h3>Importer CSV</h3>
            <p style="margin: 0; font-size: 14px; color: var(--muted);">Importez vos trades depuis un fichier CSV</p>
          </div>
          
          <div class="import-export-card">
            <i class="fa-solid fa-file-excel"></i>
            <h3>Importer Excel</h3>
            <p style="margin: 0; font-size: 14px; color: var(--muted);">Importez vos trades depuis un fichier Excel</p>
          </div>
          
          <div class="import-export-card">
            <i class="fa-solid fa-file-export"></i>
            <h3>Exporter CSV</h3>
            <p style="margin: 0; font-size: 14px; color: var(--muted);">Exportez vos trades vers un fichier CSV</p>
          </div>
          
          <div class="import-export-card">
            <i class="fa-solid fa-file-pdf"></i>
            <h3>Exporter PDF</h3>
            <p style="margin: 0; font-size: 14px; color: var(--muted);">Générez un rapport PDF de vos performances</p>
          </div>
        </div>
      </div>
    </section>

    <section id="statistiques" class="stack" style="display: none;">
      <h2 style="margin: 0 0 18px 0; display: flex; align-items: center; gap: 10px;">
        <i class="fa-solid fa-chart-simple" style="color: var(--accent);"></i>
        Statistiques Détaillées
      </h2>
      
      <div class="panel pad">
        <div class="stats-grid">
          <div class="stat-card">
            <h3>Performance Globale</h3>
            <div class="stat-value" id="totalPnl">0 €</div>
            <div class="stat-details">Bénéfice total depuis le début</div>
          </div>
          
          <div class="stat-card">
            <h3>Taux de Réussite</h3>
            <div class="stat-value" id="winRate">0%</div>
            <div class="stat-details">Pourcentage de trades gagnants</div>
          </div>
          
          <div class="stat-card">
            <h3>Profit Factor</h3>
            <div class="stat-value" id="profitFactor">0.00</div>
            <div class="stat-details">Ratio gains/pertes</div>
          </div>
          
          <div class="stat-card">
            <h3>Risque/Récompense Moyen</h3>
            <div class="stat-value" id="avgRR">0.00</div>
            <div class="stat-details">Ratio moyen par trade</div>
          </div>
        </div>
        
        <div class="detailed-stats">
          <div class="stat-item">
            <h4>Nombre total de trades</h4>
            <div class="value" id="totalTrades">0</div>
          </div>
          
          <div class="stat-item">
            <h4>Trades gagnants</h4>
            <div class="value" id="winningTrades">0</div>
          </div>
          
          <div class="stat-item">
            <h4>Trades perdants</h4>
            <div class="value" id="losingTrades">0</div>
          </div>
          
          <div class="stat-item">
            <h4>Plus gros gain</h4>
            <div class="value" id="biggestWin">0 €</div>
          </div>
          
          <div class="stat-item">
            <h4>Plus grosse perte</h4>
            <div class="value" id="biggestLoss">0 €</div>
          </div>
          
          <div class="stat-item">
            <h4>Gain moyen</h4>
            <div class="value" id="avgWin">0 €</div>
          </div>
          
          <div class="stat-item">
            <h4>Perte moyenne</h4>
            <div class="value" id="avgLoss">0 €</div>
          </div>
          
          <div class="stat-item">
            <h4>Ratio gain/pertes</h4>
            <div class="value" id="winLossRatio">0.00</div>
          </div>
        </div>
      </div>
    </section>

    <section id="rapports" class="stack" style="display: none;">
      <h2 style="margin: 0 0 18px 0; display: flex; align-items: center; gap: 10px;">
        <i class="fa-solid fa-chart-pie" style="color: var(--accent);"></i>
        Rapports de Performance
      </h2>
      
      <div class="panel pad">
        <div class="report-options">
          <div class="report-card">
            <i class="fa-solid fa-calendar-week"></i>
            <h3>Rapport Hebdomadaire</h3>
            <p style="margin: 0; font-size: 14px; color: var(--muted);">Générez un rapport détaillé de la semaine</p>
          </div>
          
          <div class="report-card">
            <i class="fa-solid fa-calendar-days"></i>
            <h3>Rapport Mensuel</h3>
            <p style="margin: 0; font-size: 14px; color: var(--muted);">Générez un rapport détaillé du mois</p>
          </div>
          
          <div class="report-card">
            <i class="fa-solid fa-calendar-day"></i>
            <h3>Rapport Trimestriel</h3>
            <p style="margin: 0; font-size: 14px; color: var(--muted);">Générez un rapport détaillé du trimestre</p>
          </div>
          
          <div class="report-card">
            <i class="fa-solid fa-calendar"></i>
            <h3>Rapport Annuel</h3>
            <p style="margin: 0; font-size: 14px; color: var(--muted);">Générez un rapport détaillé de l'année</p>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- AUTH MODAL -->
<div class="modal" id="authModal" style="display: flex;">
  <div class="card">
    <h2>Connexion</h2>
    <div class="form">
      <div class="field" style="grid-column: span 3;">
        <label class="label">Email</label>
        <input id="loginEmail" class="input" type="email" placeholder="votre@email.com"/>
      </div>
      <div class="field" style="grid-column: span 3;">
        <label class="label">Mot de passe</label>
        <input id="loginPassword" class="input" type="password" placeholder="Votre mot de passe"/>
      </div>
      <div class="field" style="grid-column: span 6; display: flex; justify-content: space-between; align-items: center;">
        <div>
          <input id="rememberMe" type="checkbox" style="margin-right: 8px;"/>
          <label for="rememberMe" style="font-size: 14px;">Se souvenir de moi</label>
        </div>
        <a href="#" id="forgotPassword" style="font-size: 14px; color: var(--accent);">Mot de passe oublié?</a>
      </div>
      <div class="field" style="grid-column: span 3;">
        <button id="loginBtn" class="btn">Connexion</button>
      </div>
      <div class="field" style="grid-column: span 3;">
        <button id="signupToggle" class="btn ghost">Créer un compte</button>
      </div>
    </div>
    
    <div style="margin: 20px 0; text-align: center; position: relative;">
      <div style="position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: rgba(255,255,255,0.1);"></div>
      <span style="background: var(--panel); padding: 0 10px; position: relative; color: var(--muted); font-size: 14px;">Ou</span>
    </div>
    
    <div style="display: flex; justify-content: center;">
      <div id="g_id_onload"
           data-client_id="1040650682872-18r0me6qma1905p4cpd5a85aefjcmaps.apps.googleusercontent.com"
           data-context="signin"
           data-ux_mode="popup"
           data-callback="handleGoogleSignIn"
           data-auto_prompt="false">
      </div>
      <div class="g_id_signin"
           data-type="standard"
           data-shape="rectangular"
           data-theme="filled_blue"
           data-text="signin_with"
           data-size="large"
           data-logo_alignment="left">
      </div>
    </div>
  </div>
</div>

<!-- SIGNUP MODAL -->
<div class="modal" id="signupModal" style="display: none;">
  <div class="card">
    <h2>Créer un compte</h2>
    <div class="form">
      <div class="field" style="grid-column: span 3;">
        <label class="label">Nom d'utilisateur</label>
        <input id="signupUsername" class="input" placeholder="Votre nom d'utilisateur"/>
      </div>
      <div class="field" style="grid-column: span 3;">
        <label class="label">Email</label>
        <input id="signupEmail" class="input" type="email" placeholder="votre@email.com"/>
      </div>
      <div class="field" style="grid-column: span 3;">
        <label class="label">Mot de passe</label>
        <input id="signupPassword" class="input" type="password" placeholder="Créez un mot de passe"/>
        <div class="password-strength" id="passwordStrength">
          <div class="password-strength-bar"></div>
        </div>
        <div class="password-rules">
          <div id="lengthRule" style="color: var(--muted);">• 8 caractères minimum</div>
          <div id="uppercaseRule" style="color: var(--muted);">• Une lettre majuscule</div>
          <div id="numberRule" style="color: var(--muted);">• Un chiffre</div>
        </div>
      </div>
      <div class="field" style="grid-column: span 3;">
        <label class="label">Confirmer le mot de passe</label>
        <input id="signupConfirmPassword" class="input" type="password" placeholder="Confirmez votre mot de passe"/>
      </div>
      <div class="field" style="grid-column: span 6;">
        <input id="termsAgree" type="checkbox" style="margin-right: 8px;"/>
        <label for="termsAgree" style="font-size: 14px;">J'accepte les <a href="#" style="color: var(--accent);">conditions d'utilisation</a> et la <a href="#" style="color: var(--accent);">politique de confidentialité</a></label>
      </div>
      <div class="field" style="grid-column: span 3;">
        <button id="signupBtn" class="btn">Créer mon compte</button>
      </div>
      <div class="field" style="grid-column: span 3;">
        <button id="loginToggle" class="btn ghost">J'ai déjà un compte</button>
      </div>
    </div>
  </div>
</div>

<!-- FORGOT PASSWORD MODAL -->
<div class="modal" id="forgotPasswordModal" style="display: none;">
  <div class="card">
    <h2>Réinitialiser le mot de passe</h2>
    <p style="margin: 0 0 16px 0; color: var(--muted);">Entrez votre adresse email pour recevoir un lien de réinitialisation.</p>
    <div class="form">
      <div class="field" style="grid-column: span 6;">
        <label class="label">Email</label>
        <input id="resetEmail" class="input" type="email" placeholder="votre@email.com"/>
      </div>
      <div class="field" style="grid-column: span 3;">
        <button id="sendResetLink" class="btn">Envoyer le lien</button>
      </div>
      <div class="field" style="grid-column: span 3;">
        <button id="cancelReset" class="btn ghost">Annuler</button>
      </div>
    </div>
  </div>
</div>

<!-- PROFILE EDIT MODAL -->
<div class="profile-modal" id="profileModal">
  <div class="profile-modal-content">
    <h3>Modifier le profil</h3>
    <div class="field">
      <label class="label">Nom d'utilisateur</label>
      <input id="profileUsername" class="input" value="YOU"/>
    </div>
    <div class="field">
      <label class="label">Email</label>
      <input id="profileEmail" class="input" type="email" value="user@example.com"/>
    </div>
    <div class="field">
      <label class="label">Nouveau mot de passe (laisser vide si inchangé)</label>
      <input id="profilePassword" class="input" type="password" placeholder="Nouveau mot de passe"/>
    </div>
    <div class="field">
      <label class="label">Confirmer le nouveau mot de passe</label>
      <input id="profileConfirmPassword" class="input" type="password" placeholder="Confirmer le mot de passe"/>
    </div>
    <div class="buttons">
      <button id="cancelProfileEdit" class="btn ghost">Annuler</button>
      <button id="saveProfile" class="btn">Enregistrer</button>
    </div>
  </div>
</div>

<!-- TOAST NOTIFICATION -->
<div class="toast" id="toast">
  <i class="fa-solid fa-circle-info"></i>
  <span id="toastMessage">Message de notification</span>
</div>

<script>
// ===== CONFIGURATION =====
const CONFIG = {
  initialCapital: 0,
  currency: '$',
  theme: 'dark',
  language: 'fr',
  timezone: '0'
};

// ===== GOOGLE SIGN-IN HANDLER =====
function handleGoogleSignIn(response) {
  console.log('Google Sign-In successful:', response);
  
  try {
    // Simuler une connexion réussie
    state.user = {
      username: 'Google User',
      email: response.email || 'user@example.com',
      password: 'google-auth'
    };
    
    localStorage.setItem('userLoggedIn', 'true');
    localStorage.setItem('userData', JSON.stringify(state.user));
    
    document.getElementById('authModal').style.display = 'none';
    document.getElementById('app').style.display = 'grid';
    
    document.getElementById('avatar').textContent = 'GUS'; // Google User
    
    showToast('Connexion Google réussie', 'success');
    
    // Initialiser l'interface
    setTimeout(() => {
      if (typeof setupCharts === 'function') setupCharts();
      if (typeof updateUI === 'function') updateUI();
    }, 100);
    
  } catch (error) {
    console.error('Google Sign-In error:', error);
    showToast('Erreur de connexion Google', 'warning');
  }
}
  
// ===== STATE =====
let state = {
  trades: [],
  notes: [],
  settings: {...CONFIG},
  user: null,
  currentView: 'overview'
};

// Variables pour le calendrier (AJOUTEZ CES LIGNES)
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();

console.log('Script chargé, initialisation...');

// Fonction pour détruire tous les graphiques existants
function destroyAllCharts() {
  console.log('Destruction de tous les graphiques...');
  
  // Liste de tous les graphiques à détruire
  const chartNames = [
    'gaugeChart', 'pieChart', 'miniBarsChart',  // ← Virgule ajoutée ici
    'equityChart', 'assetsChart', 'monthlyChart'
  ];
  
  chartNames.forEach(chartName => {
    if (window[chartName] && typeof window[chartName] === 'object' && typeof window[chartName].destroy === 'function') {
      try {
        window[chartName].destroy();
        console.log(`Graphique ${chartName} détruit`);
      } catch (error) {
        console.error(`Erreur lors de la destruction du graphique ${chartName}:`, error);
      }
    } else if (window[chartName]) {
      console.log(`Graphique ${chartName} n'a pas de méthode destroy, suppression simple`);
      window[chartName] = null;
    }
  });
}

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOMContentLoaded - Début de l initialisation');
  try {
    // Initialize the app
    initApp();
    
    // Setup event listeners
    setupEventListeners();
    
    // Setup navigation
    setupNavigation();
    
    console.log('Initialisation terminée avec succès');
  } catch (error) {
    console.error('Erreur lors de l initialisation:', error);
    // Forcer l'affichage de l'app en mode démo en cas d'erreur
    document.getElementById('app').style.display = 'grid';
    document.getElementById('authModal').style.display = 'none';
    showToast('Mode démo activé en raison d une erreur', 'warning');
  }
});

function initApp() {
  console.log('initApp() appelée');
  try {
    // Vérifier si l'utilisateur est connecté
    const isLoggedIn = localStorage.getItem('userLoggedIn') === 'true';
    
    // Initialiser state.trades si non défini
    if (!state.trades) state.trades = [];
    
    // Charger les trades depuis le localStorage
    const savedTrades = localStorage.getItem('trades');
    if (savedTrades) {
      state.trades = JSON.parse(savedTrades);
      console.log('Trades chargés:', state.trades.length);
    } else {
      state.trades = [];
      localStorage.setItem('trades', JSON.stringify(state.trades));
    }
    
    // Charger les paramètres
    const savedSettings = localStorage.getItem('settings');
    if (savedSettings) {
      state.settings = {...state.settings, ...JSON.parse(savedSettings)};
    }
    
    // Charger les données utilisateur
    const savedUser = localStorage.getItem('userData');
    if (savedUser) {
      state.user = JSON.parse(savedUser);
    }
    
    if (isLoggedIn && state.user) {
      // Show the app, hide auth modal
      document.getElementById('app').style.display = 'grid';
      document.getElementById('authModal').style.display = 'none';
      console.log('App affichée');
      
      // Mettre à jour l'avatar
      document.getElementById('avatar').textContent = state.user.username.substring(0, 3).toUpperCase();
      
      // Détruire les graphiques existants avant de les recréer
      destroyAllCharts();
      
      // Initialiser les fonctionnalités d'import/export
      setupImportExport();
      
      // Initialiser les fonctionnalités de rapport
      setupReports();
      
      // Initialiser les graphiques après un court délai
      setTimeout(() => {
        try {
          setupCharts();
          updateUI();
        } catch (error) {
          console.error('Erreur lors de l initialisation des graphiques:', error);
        }
      }, 100);
      
    } else {
      // Show auth modal, hide app
      document.getElementById('app').style.display = 'none';
      document.getElementById('authModal').style.display = 'flex';
      console.log('Modal auth affichée');
    }
    
    // Setup clock
    updateClock();
    setInterval(updateClock, 1000);
    
    // Appliquer les paramètres
    applySettings();
    
  } catch (error) {
    console.error('Erreur dans initApp:', error);
    // Mode démo de secours
    document.getElementById('app').style.display = 'grid';
    document.getElementById('authModal').style.display = 'none';
    showToast('Mode démo activé en raison d une erreur', 'warning');
  }
}
  
function applySettings() {
  // Apply theme
  if (state.settings.theme) {
    document.documentElement.setAttribute('data-theme', state.settings.theme);
    document.getElementById('themeMode').value = state.settings.theme;
  }
  
  // Apply language
  if (state.settings.language) {
    document.getElementById('language').value = state.settings.language;
  }
  
  // Apply timezone
  if (state.settings.timezone) {
    document.getElementById('timezone').value = state.settings.timezone;
    document.getElementById('gmtSelector').value = state.settings.timezone;
  }
  
  // Apply currency
  if (state.settings.currency) {
    document.getElementById('currency').value = state.settings.currency.replace('€', 'EUR').replace('$', 'USD').replace('£', 'GBP');
  }
  
  // Apply initial capital
  if (state.settings.initialCapital) {
    document.getElementById('initialCapital').value = state.settings.initialCapital;
  }
}

function setupEventListeners() {
  // Navigation
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.getAttribute('data-target');
      switchView(target);
    });
  });
  
  // Calendar navigation - VÉRIFIER SI LES ÉLÉMENTS EXISTENT
  const prevMonthBtn = document.getElementById('prevMonth');
  const nextMonthBtn = document.getElementById('nextMonth');
  
  if (prevMonthBtn) {
    prevMonthBtn.addEventListener('click', prevMonth);
  }
  
  if (nextMonthBtn) {
    nextMonthBtn.addEventListener('click', nextMonth);
  }
  
  // Secondary navigation
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      const target = tab.getAttribute('data-target');
      switchSecondaryView(target);
    });
  });
  
  // Theme toggle
  const themeToggle = document.getElementById('themeToggle');
  if (themeToggle) {
    themeToggle.addEventListener('click', toggleTheme);
  }
  
  // User menu
  const avatar = document.getElementById('avatar');
  if (avatar) {
    avatar.addEventListener('click', toggleUserMenu);
  }
  
  // Profile editing - VÉRIFIER SI LES ÉLÉMENTS EXISTENT
  const editProfileBtn = document.getElementById('editProfileBtn');
  const cancelProfileEdit = document.getElementById('cancelProfileEdit');
  const saveProfile = document.getElementById('saveProfile');
  
  if (editProfileBtn) {
    editProfileBtn.addEventListener('click', showProfileModal);
  }
  
  if (cancelProfileEdit) {
    cancelProfileEdit.addEventListener('click', hideProfileModal);
  }
  
  if (saveProfile) {
    saveProfile.addEventListener('click', saveProfile);
  }
  
  // Auth modals - VÉRIFIER SI LES ÉLÉMENTS EXISTENT
  const signupToggle = document.getElementById('signupToggle');
  const loginToggle = document.getElementById('loginToggle');
  const forgotPassword = document.getElementById('forgotPassword');
  const cancelReset = document.getElementById('cancelReset');
  const loginBtn = document.getElementById('loginBtn');
  const signupBtn = document.getElementById('signupBtn');
  const sendResetLink = document.getElementById('sendResetLink');
  
  if (signupToggle) signupToggle.addEventListener('click', showSignupModal);
  if (loginToggle) loginToggle.addEventListener('click', showLoginModal);
  if (forgotPassword) forgotPassword.addEventListener('click', showForgotPasswordModal);
  if (cancelReset) cancelReset.addEventListener('click', showLoginModal);
  if (loginBtn) loginBtn.addEventListener('click', login);
  if (signupBtn) signupBtn.addEventListener('click', signup);
  if (sendResetLink) sendResetLink.addEventListener('click', sendResetLink);
  
  // Logout
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', logout);
  }
  
  // Trade management - VÉRIFIER SI LES ÉLÉMENTS EXISTENT
  const addTradeBtn = document.getElementById('addTrade');
  const resetJournalBtn = document.getElementById('resetJournal');
  
  if (addTradeBtn) {
    addTradeBtn.addEventListener('click', addTrade);
  }
  
  if (resetJournalBtn) {
    resetJournalBtn.addEventListener('click', resetJournal);
  }
  
  // Notes - VÉRIFIER SI L'ÉLÉMENT EXISTE
  const saveNoteBtn = document.getElementById('saveNote');
  if (saveNoteBtn) {
    saveNoteBtn.addEventListener('click', saveNote);
  }
  
  // Settings - VÉRIFIER SI L'ÉLÉMENT EXISTE
  const saveSettingsBtn = document.getElementById('saveSettings');
  if (saveSettingsBtn) {
    saveSettingsBtn.addEventListener('click', saveSettings);
  }
  
  // Password strength check - VÉRIFIER SI L'ÉLÉMENT EXISTE
  const signupPassword = document.getElementById('signupPassword');
  if (signupPassword) {
    signupPassword.addEventListener('input', checkPasswordStrength);
  }
  
  // Close user menu when clicking outside
  document.addEventListener('click', (e) => {
    const userMenu = document.getElementById('userMenu');
    if (userMenu && !e.target.closest('#avatar') && !e.target.closest('#userMenu')) {
      userMenu.style.display = 'none';
    }
  });
}

function setupNavigation() {
  // Set initial active view
  switchView('overview');
}

function setupCharts() {
  console.log('Setup des graphiques...');
  
  // Détruire tous les graphiques existants d'abord
  destroyAllCharts();
  
  // Attendre que le DOM soit complètement chargé
  setTimeout(() => {
    try {
      const chartsToSetup = [
        { id: 'gaugeChart', setup: setupGaugeChart },
        { id: 'pie', setup: setupPieChart },
        { id: 'miniBars', setup: setupMiniBarsChart },
        { id: 'equityChart', setup: setupEquityChart },
        { id: 'assetsChart', setup: setupAssetsChart },
        { id: 'monthlyChart', setup: setupMonthlyChart }
      ];
      
      chartsToSetup.forEach(({ id, setup }) => {
        if (document.getElementById(id)) {
          try {
            setup();
          } catch (e) {
            console.error(`Erreur dans ${id}:`, e);
          }
        }
      });
      
      console.log('Tous les graphiques initialisés');
    } catch (error) {
      console.error('Erreur générale dans setupCharts:', error);
    }
  }, 200); // Augmenter le délai à 200ms
}

function updateUI() {
  // Update trades table
  updateTradesTable();
  
  // Update KPIs
  updateKPIs();
  
  // Update calendar
  updateCalendar();
  
  // Update notes list
  updateNotesList();
  
  // Update statistics
  updateStatistics();
}

// ===== VIEW MANAGEMENT =====
function switchView(view) {
  // Hide all views
  document.querySelectorAll('section').forEach(section => {
    section.style.display = 'none';
  });
  
  // Show selected view
  document.getElementById(view).style.display = 'grid';
  
  // Update active nav button
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  document.querySelector(`.nav-btn[data-target="${view}"]`).classList.add('active');
  
  // Update state
  state.currentView = view;
  
  // Refresh view-specific data
  if (view === 'calendar') {
    updateCalendar();
  } else if (view === 'analytics') {
    updateCharts();
  }
}

function switchSecondaryView(view) {
  // Hide all secondary views
  ['broker', 'charger', 'statistiques', 'rapports'].forEach(id => {
    document.getElementById(id).style.display = 'none';
  });
  
  // Show selected view
  document.getElementById(view).style.display = 'grid';
  
  // Update active tab
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelector(`.tab[data-target="${view}"]`).classList.add('active');
  
  // Initialiser l'import/export si on accède à la section CHARGER
  if (view === 'charger') {
    setTimeout(() => {
      setupImportExport();
    }, 100);
  }
  
  // Initialiser les rapports si on accède à la section RAPPORTS
  if (view === 'rapports') {
    setTimeout(() => {
      setupReports();
    }, 100);
  }
}
  
// ===== THEME MANAGEMENT =====
function toggleTheme() {
  const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  
  document.documentElement.setAttribute('data-theme', newTheme);
  state.settings.theme = newTheme;
  localStorage.setItem('settings', JSON.stringify(state.settings));
  
  showToast(`Mode ${newTheme === 'dark' ? 'sombre' : 'clair'} activé`, 'info');
}

// ===== USER MANAGEMENT =====
function toggleUserMenu() {
  const menu = document.getElementById('userMenu');
  menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
}

function showProfileModal() {
  document.getElementById('profileModal').style.display = 'flex';
  document.getElementById('profileUsername').value = state.user.username;
  document.getElementById('profileEmail').value = state.user.email;
  document.getElementById('profilePassword').value = '';
  document.getElementById('profileConfirmPassword').value = '';
}

function hideProfileModal() {
  document.getElementById('profileModal').style.display = 'none';
}

function saveProfile() {
  const username = document.getElementById('profileUsername').value;
  const email = document.getElementById('profileEmail').value;
  const password = document.getElementById('profilePassword').value;
  const confirmPassword = document.getElementById('profileConfirmPassword').value;
  
  if (password && password !== confirmPassword) {
    showToast('Les mots de passe ne correspondent pas', 'warning');
    return;
  }
  
  // Update user data
  state.user.username = username;
  state.user.email = email;
  if (password) {
    state.user.password = password; // In a real app, this would be hashed
  }
  
  // Save to localStorage
  localStorage.setItem('userData', JSON.stringify(state.user));
  
  // Update avatar
  document.getElementById('avatar').textContent = username.substring(0, 3).toUpperCase();
  
  hideProfileModal();
  showToast('Profil mis à jour avec succès', 'success');
}

function showSignupModal() {
  document.getElementById('authModal').style.display = 'none';
  document.getElementById('signupModal').style.display = 'flex';
}

function showLoginModal() {
  document.getElementById('signupModal').style.display = 'none';
  document.getElementById('forgotPasswordModal').style.display = 'none';
  document.getElementById('authModal').style.display = 'flex';
}

function showForgotPasswordModal() {
  document.getElementById('authModal').style.display = 'none';
  document.getElementById('forgotPasswordModal').style.display = 'flex';
}

function login() {
  console.log('Tentative de connexion...');
  try {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    if (!email || !password) {
      showToast('Veuillez remplir tous les champs', 'warning');
      return;
    }
    
    // Vérifier si l'utilisateur existe déjà
    let userData = localStorage.getItem('userData');
    if (userData) {
      state.user = JSON.parse(userData);
      
      // Vérifier les identifiants
      if (state.user.email === email && state.user.password === password) {
        // Connexion réussie avec un utilisateur existant
        console.log('Connexion réussie avec utilisateur existant');
      } else {
        // Créer un nouvel utilisateur
        state.user = {
          username: email.split('@')[0],
          email: email,
          password: password
        };
      }
    } else {
      // Créer un nouvel utilisateur
      state.user = {
        username: email.split('@')[0],
        email: email,
        password: password
      };
    }
    
    // Save to localStorage
    localStorage.setItem('userLoggedIn', 'true');
    localStorage.setItem('userData', JSON.stringify(state.user));
    
    // Initialiser les trades si non existants
    if (!localStorage.getItem('trades')) {
      localStorage.setItem('trades', JSON.stringify([]));
      state.trades = [];
    }
    
    // Hide auth modal, show app
    document.getElementById('authModal').style.display = 'none';
    document.getElementById('app').style.display = 'grid';
    
    // Update avatar
    document.getElementById('avatar').textContent = state.user.username.substring(0, 3).toUpperCase();
    
    console.log('Connexion réussie, mise à jour UI...');
    
    // Mettre à jour l'interface
    setTimeout(() => {
      try {
        setupCharts();
        updateUI();
        showToast('Connexion réussie', 'success');
      } catch (error) {
        console.error('Erreur lors de la mise à jour UI:', error);
        showToast('Connexion réussie (mode démo)', 'info');
      }
    }, 100);
    
  } catch (error) {
    console.error('Erreur dans login:', error);
    showToast('Erreur de connexion', 'warning');
  }
}

function signup() {
  const username = document.getElementById('signupUsername').value;
  const email = document.getElementById('signupEmail').value;
  const password = document.getElementById('signupPassword').value;
  const confirmPassword = document.getElementById('signupConfirmPassword').value;
  const termsAgreed = document.getElementById('termsAgree').checked;
  
  if (!username || !email || !password || !confirmPassword) {
    showToast('Veuillez remplir tous les champs', 'warning');
    return;
  }
  
  if (password !== confirmPassword) {
    showToast('Les mots de passe ne correspondent pas', 'warning');
    return;
  }
  
  if (!termsAgreed) {
    showToast('Veuillez accepter les conditions d\'utilisation', 'warning');
    return;
  }
  
  // In a real app, this would call an API
  // For demo purposes, we'll just simulate a successful signup
  state.user = {
    username: username,
    email: email,
    password: password // In a real app, this would be hashed
  };
  
  // Save to localStorage
  localStorage.setItem('userLoggedIn', 'true');
  localStorage.setItem('userData', JSON.stringify(state.user));
  
  // Hide signup modal, show app
  document.getElementById('signupModal').style.display = 'none';
  document.getElementById('app').style.display = 'grid';
  
  // Update avatar
  document.getElementById('avatar').textContent = state.user.username.substring(0, 3).toUpperCase();
  
  showToast('Compte créé avec succès', 'success');
}

function sendResetLink() {
  const email = document.getElementById('resetEmail').value;
  
  if (!email) {
    showToast('Veuillez entrer votre adresse email', 'warning');
    return;
  }
  
  // In a real app, this would call an API
  // For demo purposes, we'll just simulate sending the link
  showToast('Lien de réinitialisation envoyé à ' + email, 'info');
  showLoginModal();
}

function logout() {
  // Détruire tous les graphiques
  destroyAllCharts();
  
  // Clear user data
  state.user = null;
  
  // Clear localStorage
  localStorage.removeItem('userLoggedIn');
  localStorage.removeItem('userData');
  
  // Show auth modal, hide app
  document.getElementById('app').style.display = 'none';
  document.getElementById('authModal').style.display = 'flex';
  
  showToast('Déconnexion réussie', 'info');
}

// ===== GESTION DES TRADES =====
  function addTrade() {
  // Ajouter cette vérification au début de la fonction
  if (!state.trades) state.trades = [];
  
  const date = document.getElementById('tDate').value;
  const asset = document.getElementById('tAsset').value;
  const type = document.getElementById('tType').value;
  const entry = document.getElementById('tEntry').value; // Conserver comme string
  const exit = document.getElementById('tExit').value;   // Conserver comme string
  const lot = parseFloat(document.getElementById('tLot').value);
  const status = document.getElementById('tStatus').value;
  const resultInput = document.getElementById('tResult').value;
  const note = document.getElementById('tNote').value;

  // Validation des champs obligatoires
  if (!date || !asset || !type || !entry || !exit || isNaN(lot) || !status || !resultInput) {
    showToast('Veuillez remplir tous les champs obligatoires', 'warning');
    return;
  }

  // Conversion du P&L en nombre (gère le signe + ou -)
  let result = parseFloat(resultInput);
  
  // CORRECTION: Forcer le signe négatif pour les Loss
  if (status === 'Loss' && result > 0) {
    result = -result;
  } else if (status === 'Win' && result < 0) {
    result = Math.abs(result);
  }

  if (isNaN(result)) {
    showToast('Le P&L doit être un nombre valide', 'warning');
    return;
  }

  // Calculer le RR automatiquement
  const rr = calculateRR(parseFloat(entry), parseFloat(exit), type, result);

  // Créer l'objet trade
  const trade = {
    id: Date.now(),
    date,
    asset,
    type,
    entry: entry, // Conserver le format original
    exit: exit,   // Conserver le format original
    lot,
    status,
    result,
    rr,
    note
  };

  // Ajouter au state
  if (!state.trades) state.trades = [];
  state.trades.push(trade);

  // Sauvegarder dans le localStorage
  localStorage.setItem('trades', JSON.stringify(state.trades));

  // Mettre à jour l'UI
  updateTradesTable();
  updateKPIs();
  updateCharts();
  updateStatistics();
  updateCalendar();
  
  // Réinitialiser le formulaire
  document.getElementById('tDate').value = '';
  document.getElementById('tAsset').value = '';
  document.getElementById('tEntry').value = '';
  document.getElementById('tExit').value = '';
  document.getElementById('tLot').value = '0.01';
  document.getElementById('tResult').value = '';
  document.getElementById('tNote').value = '';

  showToast('Trade ajouté avec succès', 'success');
}

function calculateRR(entry, exit, type, pnl) {
  if (pnl === 0) return 'N/A';
  
  // Calcul simplifié du Risk/Reward
  const priceDifference = Math.abs(exit - entry);
  const risk = type === 'Buy' ? entry * 0.01 : entry * 0.01; // Approximation du risque à 1%
  
  if (pnl > 0) {
    return (pnl / risk).toFixed(2);
  } else {
    return (-risk / Math.abs(pnl)).toFixed(2);
  }
}

function updateTradesTable() {
  const tbody = document.getElementById('tradesList');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  if (!state.trades || state.trades.length === 0) {
    const emptyRow = document.createElement('tr');
    emptyRow.innerHTML = `<td colspan="10" style="text-align: center; padding: 20px; color: var(--muted);">Aucun trade enregistré</td>`;
    tbody.appendChild(emptyRow);
    return;
  }
  
  // Trier les trades par date (du plus récent au plus ancien)
  const sortedTrades = [...state.trades].sort((a, b) => new Date(b.date) - new Date(a.date));
  
  sortedTrades.forEach(trade => {
    const row = document.createElement('tr');
    
    // CORRECTION: Toujours afficher le résultat avec le bon signe et la bonne couleur
    const resultValue = typeof trade.result === 'number' ? trade.result : parseFloat(trade.result);
    const displayResult = trade.status === 'Loss' ? -Math.abs(resultValue) : Math.abs(resultValue);
    
    row.innerHTML = `
      <td>${formatDate(trade.date)}</td>
      <td>${trade.asset}</td>
      <td>${trade.type}</td>
      <td>${trade.entry}</td>  <!-- Conservation du format d'origine -->
      <td>${trade.exit}</td>   <!-- Conservation du format d'origine -->
      <td>${trade.lot.toFixed(2)}</td>
      <td><span class="pill ${trade.status === 'Win' ? 'win' : 'loss'}">${trade.status === 'Win' ? 'Gagnant' : 'Perdant'}</span></td>
      <td style="color: ${trade.status === 'Win' ? 'var(--good)' : 'var(--bad)'}; font-weight: 700;">
        ${trade.status === 'Win' ? '+' : '-'}${Math.abs(resultValue).toFixed(2)} $
      </td>
      <td>${trade.rr}</td>
      <td>${trade.note || '-'}</td>
    `;
    
    tbody.appendChild(row);
  });
}

function resetJournal() {
  if (confirm('Êtes-vous sûr de vouloir réinitialiser votre journal? Tous les trades seront supprimés.')) {
    state.trades = [];
    localStorage.setItem('trades', JSON.stringify(state.trades));
    
    updateTradesTable();
    updateKPIs();
    updateCharts(); // Mettre à jour tous les graphiques
    updateStatistics();
    updateCalendar(); // Mettre à jour le calendrier
    
    // Réinitialiser les graphiques avec des données vides
    resetAllCharts();
    
    showToast('Journal réinitialisé', 'info');
  }
}

function resetAllCharts() {
  console.log('Réinitialisation des graphiques');
  
  // Réinitialiser tous les graphiques avec des données vides
  const charts = [
    {chart: window.equityChart, data: [state.settings.initialCapital || 10000], labels: ['Capital initial']},
    {chart: window.assetsChart, data: [0], labels: ['Aucun trade']},
    {chart: window.monthlyChart, data: [0], labels: ['Aucun trade']},
    {chart: window.miniBarsChart, data: [0], labels: ['Aucun trade']}
  ];
  
  charts.forEach(({chart, data, labels}) => {
    if (chart && chart.data) {
      chart.data.datasets[0].data = data;
      chart.data.labels = labels;
      chart.update();
    }
  });
  
  // Graphique de jauge
  if (window.gaugeChart && window.gaugeChart.data) {
    window.gaugeChart.data.datasets[0].data = [0, 100];
    window.gaugeChart.update();
    if (document.getElementById('gaugeValue')) {
      document.getElementById('gaugeValue').textContent = '0%';
    }
  }
  
  // Graphique circulaire
  if (window.pieChart && window.pieChart.data) {
    window.pieChart.data.datasets[0].data = [0, 0];
    safeChartUpdate(window.pieChart);
  }
}
  
// ===== CALCULATION FUNCTIONS =====
function calculateEquityData() {
  if (!state.trades || state.trades.length === 0) {
    return [state.settings.initialCapital || 10000];
  }
  
  // Trier les trades par date
  const sortedTrades = [...state.trades].sort((a, b) => new Date(a.date) - new Date(b.date));
  
  let currentCapital = state.settings.initialCapital || 10000;
  const equityData = [currentCapital];
  
  // Ajouter l'impact de chaque trade
  sortedTrades.forEach(trade => {
    currentCapital += trade.result;
    equityData.push(currentCapital);
  });
  
  return equityData;
}

function calculateAssetPerformance() {
  const performance = {};
  
  if (!state.trades || state.trades.length === 0) {
    return performance;
  }
  
  state.trades.forEach(trade => {
    if (!performance[trade.asset]) {
      performance[trade.asset] = 0;
    }
    performance[trade.asset] += trade.result;
  });
  
  return performance;
}

function calculateMonthlyReturns() {
  const monthlyReturns = {};
  
  if (!state.trades || state.trades.length === 0) {
    return monthlyReturns;
  }
  
  state.trades.forEach(trade => {
    const date = new Date(trade.date);
    const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    
    if (!monthlyReturns[monthYear]) {
      monthlyReturns[monthYear] = 0;
    }
    monthlyReturns[monthYear] += trade.result;
  });
  
  return monthlyReturns;
}

function calculateMonthlyPerformance() {
  const monthlyPerformance = {};
  
  if (!state.trades || state.trades.length === 0) {
    return monthlyPerformance;
  }
  
  state.trades.forEach(trade => {
    const date = new Date(trade.date);
    const month = date.toLocaleString('fr-FR', { month: 'short' });
    
    if (!monthlyPerformance[month]) {
      monthlyPerformance[month] = 0;
    }
    monthlyPerformance[month] += trade.result;
  });
  
  return monthlyPerformance;
}
  
  // ===== CALENDAR FUNCTIONS =====
function getDayData(dateStr) {
  if (!state.trades || state.trades.length === 0) {
    return null;
  }
  
  // Formater la date cible pour la comparaison
  const targetDate = formatDateForComparison(dateStr);
  
  // Filtrer les trades pour cette date spécifique
  const dayTrades = state.trades.filter(trade => {
    if (!trade.date) return false;
    const tradeDate = formatDateForComparison(trade.date);
    return tradeDate === targetDate;
  });
  
  if (dayTrades.length === 0) {
    return null;
  }
  
  // Calculer le P&L total de la journée
  const dailyPnl = dayTrades.reduce((sum, trade) => {
    const result = typeof trade.result === 'number' ? trade.result : parseFloat(trade.result);
    return sum + result;
  }, 0);
  
  const currency = state.settings.currency || '$';
  
  return { 
    pnl: dailyPnl, 
    currency: currency,
    tradeCount: dayTrades.length
  };
}
 
  function updateCalendar() {
  const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 
                     'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
  document.getElementById('currentMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;
  
  const calendarGrid = document.getElementById('calendarGrid');
  // Clear existing days (keep the day headers)
  while (calendarGrid.children.length > 7) {
    calendarGrid.removeChild(calendarGrid.lastChild);
  }
  
  // Get first day of month and number of days
  const firstDay = new Date(currentYear, currentMonth, 1);
  const lastDay = new Date(currentYear, currentMonth + 1, 0);
  const daysInMonth = lastDay.getDate();
  const startingDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; // Adjust for Monday as first day
  
  // Add empty cells for days before the first day of the month
  for (let i = 0; i < startingDay; i++) {
    const emptyDay = document.createElement('div');
    emptyDay.style.minHeight = '60px';
    calendarGrid.appendChild(emptyDay);
  }
  
  // Add cells for each day of the month
  for (let i = 1; i <= daysInMonth; i++) {
    const day = document.createElement('div');
    day.className = 'calendar-day';
    
    // Format date as YYYY-MM-DD for data lookup
    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
    
    // Check if we have data for this day
    const dayData = getDayData(dateStr);
    
    day.innerHTML = `
      <div class="day-number">${i}</div>
    `;
    
    // Only add P&L if we have data
    if (dayData && dayData.pnl !== 0) {
      day.innerHTML += `<div class="day-pnl" style="color: ${dayData.pnl >= 0 ? 'var(--good)' : 'var(--bad)'}">
        ${dayData.pnl >= 0 ? '+' : ''}${dayData.pnl}${dayData.currency || '$'}
      </div>`;
      
      // Add visual indicator based on P&L
      if (dayData.pnl > 0) {
        day.classList.add('positive');
      } else if (dayData.pnl < 0) {
        day.classList.add('negative');
      }
    }
    
    calendarGrid.appendChild(day);
  }
} // ← Fin de la fonction updateCalendar()

// Ces fonctions doivent être DÉPLACÉES en dehors de updateCalendar()
function prevMonth() {
  currentMonth--;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  }
  updateCalendar();
}

function nextMonth() {
  currentMonth++;
  if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  updateCalendar();
}
// ===== UTILITY FUNCTIONS =====
function formatDateForComparison(dateString) {
  const date = new Date(dateString);
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

// Initialiser les événement
document.addEventListener('DOMContentLoaded', function() {
  // Initialize the app
  initApp();
  
  // Setup event listeners
  setupEventListeners();
  
  // Setup navigation
  setupNavigation();
  
  // Ne pas initialiser les graphiques ici, ils seront initialisés après la connexion
});
    
 
// ===== NOTES MANAGEMENT =====
function saveNote() {
  const title = document.getElementById('noteTitle').value;
  const category = document.getElementById('noteCategory').value;
  const content = document.getElementById('noteContent').value;
  
  if (!title || !content) {
    showToast('Veuillez remplir le titre et le contenu', 'warning');
    return;
  }
  
  // Create note object
  const note = {
    id: Date.now(),
    date: new Date().toISOString(),
    title,
    category,
    content
  };
  
  // Add to state
  state.notes.push(note);
  
  // Save to localStorage
  localStorage.setItem('notes', JSON.stringify(state.notes));
  
  // Update UI
  updateNotesList();
  
  // Clear form
  document.getElementById('noteTitle').value = '';
  document.getElementById('noteContent').value = '';
  
  showToast('Note enregistrée avec succès', 'success');
}

function updateNotesList() {
  const notesList = document.getElementById('notesList');
  notesList.innerHTML = '';
  
  // Sort notes by date (newest first)
  const sortedNotes = [...state.notes].sort((a, b) => new Date(b.date) - new Date(a.date));
  
  sortedNotes.forEach(note => {
    const noteEl = document.createElement('div');
    noteEl.className = 'note-item';
    
    noteEl.innerHTML = `
      <div class="note-date">${formatDate(note.date)} • ${note.category}</div>
      <h4 style="margin: 0 0 8px 0;">${note.title}</h4>
      <div class="note-content">${note.content}</div>
    `;
    
    notesList.appendChild(noteEl);
  });
}

// ===== SETTINGS MANAGEMENT =====
function saveSettings() {
  const initialCapital = parseFloat(document.getElementById('initialCapital').value);
  const currency = document.getElementById('currency').value;
  const themeMode = document.getElementById('themeMode').value;
  const language = document.getElementById('language').value;
  const timezone = document.getElementById('timezone').value;
  
  // Update settings
  state.settings.initialCapital = initialCapital;
  state.settings.currency = currency === 'EUR' ? '€' : currency === 'USD' ? '$' : currency === 'GBP' ? '£' : '€';
  state.settings.theme = themeMode;
  state.settings.language = language;
  state.settings.timezone = timezone;
  
  // Save to localStorage
  localStorage.setItem('settings', JSON.stringify(state.settings));
  
  // Apply settings
  applySettings();
  
  // Mettre à jour les graphiques qui dépendent du capital initial
  updateEquityChart();
  updateCharts();
  
  // Update UI
  updateUI();
  
  showToast('Paramètres enregistrés avec succès', 'success');
}

// ===== CALENDAR MANAGEMENT =====

function prevMonth() {
  currentMonth--;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  }
  updateCalendar();
}

function nextMonth() {
  currentMonth++;
  if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  updateCalendar();
}

function updateCalendar() {
  const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 
                     'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
  document.getElementById('currentMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;
  
  const calendarGrid = document.getElementById('calendarGrid');
  // Clear existing days (keep the day headers)
  while (calendarGrid.children.length > 7) {
    calendarGrid.removeChild(calendarGrid.lastChild);
  }
  
  // Get first day of month and number of days
  const firstDay = new Date(currentYear, currentMonth, 1);
  const lastDay = new Date(currentYear, currentMonth + 1, 0);
  const daysInMonth = lastDay.getDate();
  const startingDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; // Adjust for Monday as first day
  
  // Add empty cells for days before the first day of the month
  for (let i = 0; i < startingDay; i++) {
    const emptyDay = document.createElement('div');
    emptyDay.style.minHeight = '60px';
    calendarGrid.appendChild(emptyDay);
  }
  
  // Add cells for each day of the month
  for (let i = 1; i <= daysInMonth; i++) {
    const day = document.createElement('div');
    day.className = 'calendar-day';
    
    // Format date as YYYY-MM-DD for data lookup
    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
    
    // Check if we have data for this day
    const dayData = getDayData(dateStr);
    
    day.innerHTML = `
      <div class="day-number">${i}</div>
    `;
    
    // Only add P&L if we have data
    if (dayData && dayData.pnl !== 0) {
      day.innerHTML += `<div class="day-pnl" style="color: ${dayData.pnl >= 0 ? 'var(--good)' : 'var(--bad)'}">
        ${dayData.pnl >= 0 ? '+' : ''}${dayData.pnl}${dayData.currency || '$'}
      </div>`;
      
      // Add visual indicator based on P&L
      if (dayData.pnl > 0) {
        day.classList.add('positive');
      } else if (dayData.pnl < 0) {
        day.classList.add('negative');
      }
    }
   calendarGrid.appendChild(day);
  }
} // L'accolade fermante est maintenant présente


// Initialize calendar when page loads
document.addEventListener('DOMContentLoaded', function() {
  // Add event listeners for calendar navigation
  document.getElementById('prevMonth').addEventListener('click', prevMonth);
  document.getElementById('nextMonth').addEventListener('click', nextMonth);
  
  // Initialize calendar
  updateCalendar();
});
  

// ===== STATISTICS =====
function updateStatistics() {
  if (!state.trades || state.trades.length === 0) {
    // Réinitialiser les statistiques si aucun trade
    document.getElementById('totalTrades').textContent = '0';
    document.getElementById('winningTrades').textContent = '0';
    document.getElementById('losingTrades').textContent = '0';
    document.getElementById('totalPnl').textContent = '0 $';
    document.getElementById('winRate').textContent = '0%';
    document.getElementById('profitFactor').textContent = '0.00';
    document.getElementById('avgRR').textContent = '0.00';
    document.getElementById('biggestWin').textContent = '0 $';
    document.getElementById('biggestLoss').textContent = '0 $';
    document.getElementById('avgWin').textContent = '0 $';
    document.getElementById('avgLoss').textContent = '0 $';
    document.getElementById('winLossRatio').textContent = '0.00';
    return;
  }

  // Calculer les statistiques
  const totalTrades = state.trades.length;
  const winningTrades = state.trades.filter(t => t.status === 'Win').length;
  const losingTrades = state.trades.filter(t => t.status === 'Loss').length;
  const winRate = totalTrades > 0 ? (winningTrades / totalTrades * 100) : 0;
  
  const totalPnl = state.trades.reduce((sum, trade) => sum + trade.result, 0);
  const winningPnl = state.trades.filter(t => t.status === 'Win').reduce((sum, trade) => sum + trade.result, 0);
  const losingPnl = state.trades.filter(t => t.status === 'Loss').reduce((sum, trade) => sum + trade.result, 0);
  
  const profitFactor = losingPnl !== 0 ? Math.abs(winningPnl / losingPnl) : winningPnl > 0 ? Infinity : 0;
  
  const biggestWin = winningTrades > 0 ? Math.max(...state.trades.filter(t => t.status === 'Win').map(t => t.result)) : 0;
  const biggestLoss = losingTrades > 0 ? Math.min(...state.trades.filter(t => t.status === 'Loss').map(t => t.result)) : 0;
  
  const avgWin = winningTrades > 0 ? winningPnl / winningTrades : 0;
  const avgLoss = losingTrades > 0 ? losingPnl / losingTrades : 0;
  const winLossRatio = avgLoss !== 0 ? Math.abs(avgWin / avgLoss) : avgWin > 0 ? Infinity : 0;
  
  const avgRR = state.trades.length > 0 ? state.trades.reduce((sum, trade) => sum + parseFloat(trade.rr || 0), 0) / state.trades.length : 0;

  // Mettre à jour l'UI
  document.getElementById('totalTrades').textContent = totalTrades;
  document.getElementById('winningTrades').textContent = winningTrades;
  document.getElementById('losingTrades').textContent = losingTrades;
  document.getElementById('totalPnl').textContent = `${totalPnl >= 0 ? '+' : ''}${totalPnl.toFixed(2)} $`;
  document.getElementById('winRate').textContent = `${winRate.toFixed(1)}%`;
  document.getElementById('profitFactor').textContent = profitFactor.toFixed(2);
  document.getElementById('avgRR').textContent = avgRR.toFixed(2);
  document.getElementById('biggestWin').textContent = `${biggestWin >= 0 ? '+' : ''}${biggestWin.toFixed(2)} $`;
  document.getElementById('biggestLoss').textContent = `${biggestLoss >= 0 ? '+' : ''}${biggestLoss.toFixed(2)} $`;
  document.getElementById('avgWin').textContent = `${avgWin >= 0 ? '+' : ''}${avgWin.toFixed(2)} $`;
  document.getElementById('avgLoss').textContent = `${avgLoss >= 0 ? '+' : ''}${avgLoss.toFixed(2)} $`;
  document.getElementById('winLossRatio').textContent = winLossRatio.toFixed(2);
}

// ===== CHARTS =====
function setupGaugeChart() {
  const ctxElement = document.getElementById('gaugeChart');
  if (!ctxElement) {
    console.log('Element gaugeChart non trouvé');
    return;
  }
  
  // Détruire le graphique existant s'il y en a un
  if (window.gaugeChart && typeof window.gaugeChart.destroy === 'function') {
    try {
      window.gaugeChart.destroy();
    } catch (e) {
      console.error('Erreur destruction gaugeChart:', e);
    }
  }
  
  const ctx = ctxElement.getContext('2d');
  window.gaugeChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      datasets: [{
        data: [50, 50],
        backgroundColor: ['#675CFF', 'rgba(255,255,255,0.1)'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '80%',
      rotation: -90,
      circumference: 180,
      plugins: {
        legend: { display: false },
        tooltip: { enabled: false }
      }
    }
  });
}
  
function setupPieChart() {
  const ctxElement = document.getElementById('pie');
  if (!ctxElement) {
    console.log('Element pie non trouvé');
    return;
  }
  
  // Détruire le graphique existant s'il y en a un
  if (window.pieChart) {
    try {
      window.pieChart.destroy();
    } catch (e) {
      console.error('Erreur destruction pieChart:', e);
    }
  }
  
  const ctx = ctxElement.getContext('2d');
  window.pieChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: ['Gagnants', 'Perdants'],
      datasets: [{
        data: [60, 40],
        backgroundColor: ['#28e98c', '#ff6b6b']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });
}
  
  function setupMiniBarsChart() {
  const ctxElement = document.getElementById('miniBars');
  if (!ctxElement) {
    console.log('Element miniBars non trouvé');
    return;
  }
  
  // Détruire le graphique existant s'il y en a un
  if (window.miniBarsChart && typeof window.miniBarsChart.destroy === 'function') {
    try {
      window.miniBarsChart.destroy();
    } catch (e) {
      console.error('Erreur destruction miniBarsChart:', e);
    }
  }
  
  const ctx = ctxElement.getContext('2d');
  window.miniBarsChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Aucun trade'],
      datasets: [{
        data: [0],
        backgroundColor: '#675CFF'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          display: false
        },
        x: {
          grid: { display: false }
        }
      }
    }
  });
}

function setupEquityChart() {
  const ctxElement = document.getElementById('equityChart');
  if (!ctxElement) {
    console.log('Element equityChart non trouvé');
    return;
  }
  
  // Détruire le graphique existant s'il y en a un
  if (window.equityChart && typeof window.equityChart.destroy === 'function') {
    try {
      window.equityChart.destroy();
    } catch (e) {
      console.error('Erreur destruction equityChart:', e);
    }
  }
  
  const ctx = ctxElement.getContext('2d');
  window.equityChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: ['Capital initial'],
      datasets: [{
        label: 'Capital',
        data: [state.settings.initialCapital || 10000],
        borderColor: '#675CFF',
        backgroundColor: 'rgba(103, 92, 255, 0.1)',
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: false
        }
      }
    }
  });
}

function setupAssetsChart() {
  const ctxElement = document.getElementById('assetsChart');
  if (!ctxElement) {
    console.log('Element assetsChart non trouvé');
    return;
  }
  
  // Détruire le graphique existant s'il y en a un
  if (window.assetsChart && typeof window.assetsChart.destroy === 'function') {
    try {
      window.assetsChart.destroy();
    } catch (e) {
      console.error('Erreur destruction assetsChart:', e);
    }
  }
  
  const ctx = ctxElement.getContext('2d');
  window.assetsChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Aucun trade'],
      datasets: [{
        label: 'Performance',
        data: [0],
        backgroundColor: ['#675CFF']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      indexAxis: 'y',
      scales: {
        x: {
          beginAtZero: true
        }
      }
    }
  });
}

function setupMonthlyChart() {
  const ctxElement = document.getElementById('monthlyChart');
  if (!ctxElement) {
    console.log('Element monthlyChart non trouvé');
    return;
  }
  
  // Détruire le graphique existant s'il y en a un
  if (window.monthlyChart && typeof window.monthlyChart.destroy === 'function') {
    try {
      window.monthlyChart.destroy();
    } catch (e) {
      console.error('Erreur destruction monthlyChart:', e);
    }
  }
  
  const ctx = ctxElement.getContext('2d');
  window.monthlyChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Aucun trade'],
      datasets: [{
        label: 'Rendement',
        data: [0],
        backgroundColor: ['#675CFF']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return value + '%';
            }
          }
        }
      }
    }
  });
}

function setupCharts() {
  console.log('Setup des graphiques...');
  
  // Détruire tous les graphiques existants d'abord
  destroyAllCharts();
  
  // Attendre un peu pour s'assurer que la destruction est terminée
  setTimeout(() => {
    try {
      if (document.getElementById('gaugeChart')) setupGaugeChart();
      if (document.getElementById('pie')) setupPieChart();
      if (document.getElementById('miniBars')) setupMiniBarsChart();
      if (document.getElementById('equityChart')) setupEquityChart();
      if (document.getElementById('assetsChart')) setupAssetsChart();
      if (document.getElementById('monthlyChart')) setupMonthlyChart();
      
      console.log('Tous les graphiques initialisés');
    } catch (error) {
      console.error('Erreur générale dans setupCharts:', error);
    }
  }, 100);
}
  
// ===== FONCTION UPDATE CHARTS =====
function updateCharts() {
  console.log('Mise à jour des graphiques...');
  
  if (!state.trades || state.trades.length === 0) {
    // Réinitialiser tous les graphiques si aucun trade
    resetAllCharts();
    return;
  }

  // Mettre à jour TOUS les graphiques
  updateEquityChart();
  updateAssetsChart();
  updateMonthlyChart();
  updateMiniBarsChart();
  
  // Mettre à jour également la jauge et le pie chart
  const winningTrades = state.trades.filter(t => t.status === 'Win').length;
  const losingTrades = state.trades.filter(t => t.status === 'Loss').length;
  const winRate = state.trades.length > 0 
    ? (winningTrades / state.trades.length * 100) 
    : 0;

  if (window.gaugeChart && window.gaugeChart.data && window.gaugeChart.data.datasets) {
    window.gaugeChart.data.datasets[0].data = [winRate, 100 - winRate];
    window.gaugeChart.update();
    if (document.getElementById('gaugeValue')) {
      document.getElementById('gaugeValue').textContent = `${winRate.toFixed(1)}%`;
    }
  }
  
  if (window.pieChart && window.pieChart.data && window.pieChart.data.datasets) {
    window.pieChart.data.datasets[0].data = [winningTrades, losingTrades];
    window.pieChart.update();
  }
}

function updateEquityChart() {
  if (!window.equityChart) {
    console.log('Equity chart non initialisé');
    return;
  }
  
  const equityData = calculateEquityData();
  
  if (equityData.length === 0) {
    window.equityChart.data.datasets[0].data = [state.settings.initialCapital || 10000];
  } else {
    window.equityChart.data.datasets[0].data = equityData;
    
    // Mettre à jour les labels pour correspondre aux données
    const labels = [];
    for (let i = 0; i < equityData.length; i++) {
      labels.push(`Jour ${i + 1}`);
    }
    window.equityChart.data.labels = labels;
  }
  
  safeChartUpdate(window.equityChart);
}
  
function updateAssetsChart() {
  if (!window.assetsChart) {
    console.log('Assets chart non initialisé');
    return;
  }
  
  const assetPerformance = calculateAssetPerformance();
  const assets = Object.keys(assetPerformance);
  const performances = Object.values(assetPerformance);
  
  if (assets.length === 0) {
    window.assetsChart.data.labels = ['Aucun trade'];
    window.assetsChart.data.datasets[0].data = [0];
    window.assetsChart.data.datasets[0].backgroundColor = ['#675CFF'];
  } else {
    window.assetsChart.data.labels = assets;
    window.assetsChart.data.datasets[0].data = performances;
    
    // Générer des couleurs différentes pour chaque actif
    const colors = ['#675CFF', '#00C6FF', '#FF3D71', '#28e98c', '#ff6b6b', '#FFC107'];
    const backgroundColors = assets.map((_, index) => colors[index % colors.length]);
    window.assetsChart.data.datasets[0].backgroundColor = backgroundColors;
  }
  
 safeChartUpdate(window.assetsChart);
}

function updateMonthlyChart() {
  if (!window.monthlyChart) {
    console.log('Monthly chart non initialisé');
    return;
  }
  
  const monthlyReturns = calculateMonthlyReturns();
  const months = Object.keys(monthlyReturns);
  const returns = Object.values(monthlyReturns);
  
  if (months.length === 0) {
    window.monthlyChart.data.labels = ['Aucun trade'];
    window.monthlyChart.data.datasets[0].data = [0];
  } else {
    window.monthlyChart.data.labels = months;
    window.monthlyChart.data.datasets[0].data = returns;
    
    // Colorer en vert les gains et en rouge les pertes
    const backgroundColors = returns.map(value => value >= 0 ? '#28e98c' : '#ff6b6b');
    window.monthlyChart.data.datasets[0].backgroundColor = backgroundColors;
  }
  
safeChartUpdate(window.monthlyChart);
}

function updateMiniBarsChart() {
  if (!window.miniBarsChart) {
    console.log('Mini bars chart non initialisé');
    return;
  }
  
  const monthlyPerformance = calculateMonthlyPerformance();
  const months = Object.keys(monthlyPerformance);
  const performances = Object.values(monthlyPerformance);
  
  if (months.length === 0) {
    window.miniBarsChart.data.labels = ['Aucun trade'];
    window.miniBarsChart.data.datasets[0].data = [0];
  } else {
    window.miniBarsChart.data.labels = months;
    window.miniBarsChart.data.datasets[0].data = performances;
  }

safeChartUpdate(window.miniBarsChart);
}

// ===== KPIs =====
function updateKPIs() {
  if (!state.trades || state.trades.length === 0) {
    // Aucun trade, réinitialiser les indicateurs
    document.getElementById('kpi-win').textContent = '0%';
    document.getElementById('ring-win').style.setProperty('--val', 0);
    document.getElementById('kpi-month').textContent = '0%';
    document.getElementById('ring-month').style.setProperty('--val', 0);
    document.getElementById('mWin').textContent = '0%';
    document.getElementById('mLoss').textContent = '0%';
    document.getElementById('barWin').style.width = '0%';
    document.getElementById('barLoss').style.width = '0%';
    document.getElementById('gaugeValue').textContent = '0%';
    return;
  }

  // Calculer le taux de réussite
  const totalTrades = state.trades.length;
  const winningTrades = state.trades.filter(t => t.status === 'Win').length;
  const winRate = totalTrades > 0 ? (winningTrades / totalTrades * 100) : 0;

  // Mettre à jour le taux de réussite KPI
  document.getElementById('kpi-win').textContent = `${winRate.toFixed(1)}%`;
  document.getElementById('ring-win').style.setProperty('--val', winRate);

  // Calculer l'objectif mensuel (exemple: 70% de l'objectif)
  const monthlyGoal = 70;
  document.getElementById('kpi-month').textContent = `${monthlyGoal}%`;
  document.getElementById('ring-month').style.setProperty('--val', monthlyGoal);

  // Mettre à jour les stats du mois
  document.getElementById('mWin').textContent = `${winRate.toFixed(1)}%`;
  document.getElementById('mLoss').textContent = `${(100 - winRate).toFixed(1)}%`;
  document.getElementById('barWin').style.width = `${winRate}%`;
  document.getElementById('barLoss').style.width = `${100 - winRate}%`;

  // Mettre à jour la jauge
  document.getElementById('gaugeValue').textContent = `${winRate.toFixed(1)}%`;
  if (window.gaugeChart) {
    window.gaugeChart.data.datasets[0].data = [winRate, 100 - winRate];
    safeChartUpdate(window.gaugeChart);
  }
}

// ===== UTILITY FUNCTIONS =====
function formatDate(dateString) {
  const date = new Date(dateString);
  return new Intl.DateTimeFormat('fr-FR', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric'
  }).format(date);
}

    function formatDateForComparison(dateString) {
  const date = new Date(dateString);
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}
    
function updateClock() {
  const now = new Date();
  const timezoneOffset = parseInt(document.getElementById('gmtSelector').value);
  
  // Adjust time based on selected timezone
  const adjustedTime = new Date(now.getTime() + (timezoneOffset * 60 + now.getTimezoneOffset()) * 60000);
  
  const hours = adjustedTime.getHours().toString().padStart(2, '0');
  const minutes = adjustedTime.getMinutes().toString().padStart(2, '0');
  const seconds = adjustedTime.getSeconds().toString().padStart(2, '0');
  
  document.getElementById('clockTime').textContent = `${hours}:${minutes}:${seconds}`;
}

function safeChartUpdate(chart) {
  try {
    if (chart && typeof chart.update === 'function') {
      chart.update();
    }
  } catch (error) {
    console.error('Erreur lors de la mise à jour du graphique:', error);
  }
}
  
function checkPasswordStrength() {
  const password = document.getElementById('signupPassword').value;
  const strengthBar = document.getElementById('passwordStrength');
  const lengthRule = document.getElementById('lengthRule');
  const uppercaseRule = document.getElementById('uppercaseRule');
  const numberRule = document.getElementById('numberRule');
  
  // Reset rules
  lengthRule.style.color = 'var(--muted)';
  uppercaseRule.style.color = 'var(--muted)';
  numberRule.style.color = 'var(--muted)';
  
  let strength = 0;
  
  // Check length
  if (password.length >= 8) {
    strength++;
    lengthRule.style.color = 'var(--good)';
  }
  
  // Check uppercase
  if (/[A-Z]/.test(password)) {
    strength++;
    uppercaseRule.style.color = 'var(--good)';
  }
  
  // Check number
  if (/[0-9]/.test(password)) {
    strength++;
    numberRule.style.color = 'var(--good)';
  }
  
  // Update strength bar
  strengthBar.className = 'password-strength';
  if (strength === 1) {
    strengthBar.classList.add('weak');
  } else if (strength === 2) {
    strengthBar.classList.add('medium');
  } else if (strength >= 3) {
    strengthBar.classList.add('strong');
  }
}

function showToast(message, type = 'info') {
  const toast = document.getElementById('toast');
  const toastMessage = document.getElementById('toastMessage');
  const toastIcon = toast.querySelector('i');
  
  toastMessage.textContent = message;
  
  // Set icon based on type
  toastIcon.className = '';
  if (type === 'success') {
    toastIcon.className = 'fa-solid fa-circle-check success';
  } else if (type === 'warning') {
    toastIcon.className = 'fa-solid fa-triangle-exclamation warning';
  } else if (type === 'info') {
    toastIcon.className = 'fa-solid fa-circle-info info';
  }
  
  // Show toast
  toast.classList.add('show');
  
  // Hide after 3 seconds
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// Google Sign-In callback (for demo purposes)
function handleGoogleSignIn(response) {
  try {
    console.log('Google Sign-In successful:', response);
    
    // Simuler une connexion réussie
    state.user = {
      username: 'Google User',
      email: response.email || 'user@example.com',
      password: 'google-auth'
    };
    
    localStorage.setItem('userLoggedIn', 'true');
    localStorage.setItem('userData', JSON.stringify(state.user));
    
    document.getElementById('authModal').style.display = 'none';
    document.getElementById('app').style.display = 'grid';
    
    document.getElementById('avatar').textContent = 'GUS';
    
    showToast('Connexion Google réussie', 'success');
    
    // Réinitialiser les graphiques
    setTimeout(() => {
      try {
        destroyAllCharts();
        setupCharts();
        updateUI();
      } catch (error) {
        console.error('Erreur initialisation après connexion:', error);
      }
    }, 100);
    
  } catch (error) {
    console.error('Google Sign-In error:', error);
    showToast('Erreur de connexion Google', 'warning');
    
    // Mode démo de secours
    document.getElementById('app').style.display = 'grid';
    document.getElementById('authModal').style.display = 'none';
  }
}
    
  // Secours ultime: si l'app est bloquée après 5 secondes, forcer le mode démo
setTimeout(function() {
  if (document.getElementById('authModal') && 
      document.getElementById('authModal').style.display === 'flex') {
    console.log('Déblocage automatique activé (secours)');
    
    // Forcer l'affichage de l'app
    document.getElementById('app').style.display = 'grid';
    document.getElementById('authModal').style.display = 'none';
    
    // Initialiser l'état par défaut
    if (!state.trades) state.trades = [];
    if (!state.user) {
      state.user = { username: 'DEMO', email: 'demo@example.com' };
    }
    
    // Mettre à jour l'avatar
    document.getElementById('avatar').textContent = 'DEM';
    
    showToast('Mode démo activé (mode secours)', 'info');
    
    // Initialiser les graphiques en mode démo
    setTimeout(() => {
      try {
        setupCharts();
        updateUI();
      } catch (e) {
        console.error('Erreur initialisation mode secours:', e);
      }
    }, 500);
  }
}, 5000); // 5 secondes
    
// Initialize the app when DOM is loaded
if (document.readyState !== 'loading') {
  // DOM is already ready, initialize immediately
  initApp();
} else {
  // Wait for DOM to be ready
  document.addEventListener('DOMContentLoaded', initApp);
}
  // Secours: si l'app est bloquée, forcer l'affichage après 3 secondes
setTimeout(function() {
  if (document.getElementById('authModal').style.display === 'flex') {
    console.log('Déblocage automatique activé');
    document.getElementById('app').style.display = 'grid';
    document.getElementById('authModal').style.display = 'none';
    showToast('Mode démo activé', 'info');
  }
}, 3000);
  
  // ===== IMPORT/EXPORT FUNCTIONS =====
function setupImportExport() {
  // CSV Import
  const csvImportCard = document.querySelector('.import-export-card:nth-child(1)');
  if (csvImportCard) {
    csvImportCard.addEventListener('click', handleCSVImport);
  }
  
  // Excel Import (simulation)
  const excelImportCard = document.querySelector('.import-export-card:nth-child(2)');
  if (excelImportCard) {
    excelImportCard.addEventListener('click', handleExcelImport);
  }
  
  // CSV Export
  const csvExportCard = document.querySelector('.import-export-card:nth-child(3)');
  if (csvExportCard) {
    csvExportCard.addEventListener('click', exportToCSV);
  }
  
  // PDF Export (simulation)
  const pdfExportCard = document.querySelector('.import-export-card:nth-child(4)');
  if (pdfExportCard) {
    pdfExportCard.addEventListener('click', exportToPDF);
  }
}

function handleCSVImport() {
  // Créer un input file caché pour l'import CSV
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = '.csv';
  fileInput.style.display = 'none';
  
  fileInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const csvData = e.target.result;
        parseCSVData(csvData);
      };
      reader.readAsText(file);
    }
  });
  
  document.body.appendChild(fileInput);
  fileInput.click();
  document.body.removeChild(fileInput);
}

function handleExcelImport() {
  showToast('Fonctionnalité Excel en cours de développement', 'info');
}

function parseCSVData(csvData) {
  try {
    const lines = csvData.split('\n');
    const headers = lines[0].split(',').map(header => header.trim());
    
    const newTrades = [];
    
    for (let i = 1; i < lines.length; i++) {
      if (!lines[i].trim()) continue;
      
      const values = lines[i].split(',').map(value => value.trim());
      if (values.length !== headers.length) continue;
      
      const trade = {
        id: Date.now() + i,
        date: values[0] || new Date().toISOString().split('T')[0],
        asset: values[1] || 'N/A',
        type: values[2] || 'Buy',
        entry: values[3] || '0',
        exit: values[4] || '0',
        lot: parseFloat(values[5]) || 0.01,
        status: values[6] || 'Win',
        result: parseFloat(values[7]) || 0,
        note: values[8] || ''
      };
      
      newTrades.push(trade);
    }
    
    if (newTrades.length > 0) {
      state.trades = [...state.trades, ...newTrades];
      localStorage.setItem('trades', JSON.stringify(state.trades));
      updateTradesTable();
      updateUI();
      showToast(`${newTrades.length} trades importés avec succès`, 'success');
    } else {
      showToast('Aucun trade valide trouvé dans le fichier', 'warning');
    }
  } catch (error) {
    console.error('Erreur lors de l\'import CSV:', error);
    showToast('Erreur lors de l\'import du fichier CSV', 'warning');
  }
}

function exportToCSV() {
  if (!state.trades || state.trades.length === 0) {
    showToast('Aucun trade à exporter', 'warning');
    return;
  }
  
  try {
    // Créer le contenu CSV
    const headers = ['Date', 'Actif', 'Type', 'Entrée', 'Sortie', 'Lot', 'Résultat', 'P&L', 'Note'];
    let csvContent = headers.join(',') + '\n';
    
    state.trades.forEach(trade => {
      const row = [
        trade.date,
        trade.asset,
        trade.type,
        trade.entry,
        trade.exit,
        trade.lot,
        trade.status,
        trade.result,
        trade.note || ''
      ];
      csvContent += row.join(',') + '\n';
    });
    
    // Créer et télécharger le fichier
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `journal-trades-${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('Export CSV réussi', 'success');
  } catch (error) {
    console.error('Erreur lors de l\'export CSV:', error);
    showToast('Erreur lors de l\'export CSV', 'warning');
  }
}

function exportToPDF() {
  showToast('Fonctionnalité PDF en cours de développement', 'info');
}

  // ===== FONCTIONS DE RAPPORT =====
function setupReports() {
  // Rapport Hebdomadaire
  const weeklyReportCard = document.querySelector('.report-card:nth-child(1)');
  if (weeklyReportCard) {
    weeklyReportCard.addEventListener('click', generateWeeklyReport);
  }
  
  // Rapport Mensuel
  const monthlyReportCard = document.querySelector('.report-card:nth-child(2)');
  if (monthlyReportCard) {
    monthlyReportCard.addEventListener('click', generateMonthlyReport);
  }
  
  // Rapport Trimestriel
  const quarterlyReportCard = document.querySelector('.report-card:nth-child(3)');
  if (quarterlyReportCard) {
    quarterlyReportCard.addEventListener('click', generateQuarterlyReport);
  }
  
  // Rapport Annuel
  const yearlyReportCard = document.querySelector('.report-card:nth-child(4)');
  if (yearlyReportCard) {
    yearlyReportCard.addEventListener('click', generateYearlyReport);
  }
}

function generateWeeklyReport() {
  if (!state.trades || state.trades.length === 0) {
    showToast('Aucun trade à inclure dans le rapport', 'warning');
    return;
  }
  
  try {
    // Calculer la date de début de la semaine (lundi)
    const now = new Date();
    const startOfWeek = new Date(now);
    startOfWeek.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1));
    startOfWeek.setHours(0, 0, 0, 0);
    
    // Filtrer les trades de cette semaine
    const weeklyTrades = state.trades.filter(trade => {
      const tradeDate = new Date(trade.date);
      return tradeDate >= startOfWeek && tradeDate <= now;
    });
    
    if (weeklyTrades.length === 0) {
      showToast('Aucun trade cette semaine', 'info');
      return;
    }
    
    // Générer le contenu du rapport
    generateReport('hebdomadaire', weeklyTrades, startOfWeek, now);
    
  } catch (error) {
    console.error('Erreur génération rapport hebdomadaire:', error);
    showToast('Erreur lors de la génération du rapport', 'warning');
  }
}

function generateMonthlyReport() {
  if (!state.trades || state.trades.length === 0) {
    showToast('Aucun trade à inclure dans le rapport', 'warning');
    return;
  }
  
  try {
    // Calculer le début du mois
    const now = new Date();
    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
    
    // Filtrer les trades de ce mois
    const monthlyTrades = state.trades.filter(trade => {
      const tradeDate = new Date(trade.date);
      return tradeDate >= startOfMonth && tradeDate <= now;
    });
    
    if (monthlyTrades.length === 0) {
      showToast('Aucun trade ce mois', 'info');
      return;
    }
    
    // Générer le contenu du rapport
    generateReport('mensuel', monthlyTrades, startOfMonth, now);
    
  } catch (error) {
    console.error('Erreur génération rapport mensuel:', error);
    showToast('Erreur lors de la génération du rapport', 'warning');
  }
}

function generateQuarterlyReport() {
  if (!state.trades || state.trades.length === 0) {
    showToast('Aucun trade à inclure dans le rapport', 'warning');
    return;
  }
  
  try {
    // Calculer le début du trimestre
    const now = new Date();
    const currentQuarter = Math.floor(now.getMonth() / 3);
    const startOfQuarter = new Date(now.getFullYear(), currentQuarter * 3, 1);
    
    // Filtrer les trades de ce trimestre
    const quarterlyTrades = state.trades.filter(trade => {
      const tradeDate = new Date(trade.date);
      return tradeDate >= startOfQuarter && tradeDate <= now;
    });
    
    if (quarterlyTrades.length === 0) {
      showToast('Aucun trade ce trimestre', 'info');
      return;
    }
    
    // Générer le contenu du rapport
    generateReport('trimestriel', quarterlyTrades, startOfQuarter, now);
    
  } catch (error) {
    console.error('Erreur génération rapport trimestriel:', error);
    showToast('Erreur lors de la génération du rapport', 'warning');
  }
}

function generateYearlyReport() {
  if (!state.trades || state.trades.length === 0) {
    showToast('Aucun trade à inclure dans le rapport', 'warning');
    return;
  }
  
  try {
    // Calculer le début de l'année
    const now = new Date();
    const startOfYear = new Date(now.getFullYear(), 0, 1);
    
    // Filtrer les trades de cette année
    const yearlyTrades = state.trades.filter(trade => {
      const tradeDate = new Date(trade.date);
      return tradeDate >= startOfYear && tradeDate <= now;
    });
    
    if (yearlyTrades.length === 0) {
      showToast('Aucun trade cette année', 'info');
      return;
    }
    
    // Générer le contenu du rapport
    generateReport('annuel', yearlyTrades, startOfYear, now);
    
  } catch (error) {
    console.error('Erreur génération rapport annuel:', error);
    showToast('Erreur lors de la génération du rapport', 'warning');
  }
}

function generateReport(periodType, trades, startDate, endDate) {
  // Calculer les statistiques du rapport
  const totalTrades = trades.length;
  const winningTrades = trades.filter(t => t.status === 'Win').length;
  const losingTrades = trades.filter(t => t.status === 'Loss').length;
  const winRate = totalTrades > 0 ? (winningTrades / totalTrades * 100) : 0;
  
  const totalPnl = trades.reduce((sum, trade) => sum + trade.result, 0);
  const winningPnl = trades.filter(t => t.status === 'Win').reduce((sum, trade) => sum + trade.result, 0);
  const losingPnl = trades.filter(t => t.status === 'Loss').reduce((sum, trade) => sum + trade.result, 0);
  
  const profitFactor = losingPnl !== 0 ? Math.abs(winningPnl / losingPnl) : winningPnl > 0 ? Infinity : 0;
  
  const bestTrade = winningTrades > 0 ? Math.max(...trades.filter(t => t.status === 'Win').map(t => t.result)) : 0;
  const worstTrade = losingTrades > 0 ? Math.min(...trades.filter(t => t.status === 'Loss').map(t => t.result)) : 0;
  
  // Formater les dates
  const formatDate = (date) => date.toLocaleDateString('fr-FR');
  
  // Créer le contenu HTML du rapport
  const reportContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Rapport ${periodType} de trading</title>
      <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        h1 { color: #333; }
        .header { background: #f5f5f5; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
        .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #f9f9f9; padding: 15px; border-radius: 5px; border-left: 4px solid #675CFF; }
        .positive { color: green; }
        .negative { color: red; }
        .summary { margin-top: 30px; }
      </style>
    </head>
    <body>
      <div class="header">
        <h1>Rapport ${periodType} de trading</h1>
        <p>Période du ${formatDate(startDate)} au ${formatDate(endDate)}</p>
      </div>
      
      <div class="stats">
        <div class="stat-card">
          <h3>Nombre total de trades</h3>
          <p>${totalTrades}</p>
        </div>
        <div class="stat-card">
          <h3>Taux de réussite</h3>
          <p>${winRate.toFixed(2)}%</p>
        </div>
        <div class="stat-card">
          <h3>Profit total</h3>
          <p class="${totalPnl >= 0 ? 'positive' : 'negative'}">${totalPnl >= 0 ? '+' : ''}${totalPnl.toFixed(2)} €</p>
        </div>
        <div class="stat-card">
          <h3>Profit Factor</h3>
          <p>${profitFactor.toFixed(2)}</p>
        </div>
        <div class="stat-card">
          <h3>Meilleur trade</h3>
          <p class="positive">+${bestTrade.toFixed(2)} €</p>
        </div>
        <div class="stat-card">
          <h3>Pire trade</h3>
          <p class="negative">${worstTrade.toFixed(2)} €</p>
        </div>
      </div>
      
      <div class="summary">
        <h2>Résumé des performances</h2>
        <p>Votre performance ${periodType} montre ${totalPnl >= 0 ? 'un gain' : 'une perte'} de <strong>${Math.abs(totalPnl).toFixed(2)} €</strong> sur ${totalTrades} trades réalisés.</p>
        <p>Votre taux de réussite est de <strong>${winRate.toFixed(2)}%</strong> avec un ratio gain/pertes de <strong>${profitFactor.toFixed(2)}</strong>.</p>
      </div>
    </body>
    </html>
  `;
  
  // Ouvrir le rapport dans une nouvelle fenêtre
  const reportWindow = window.open('', '_blank');
  reportWindow.document.write(reportContent);
  reportWindow.document.close();
  
  showToast(`Rapport ${periodType} généré avec succès`, 'success');
}
  
</script>
</body>
</html>